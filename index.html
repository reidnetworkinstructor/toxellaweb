<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Toxella ‚Äî Communication Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Analyze conversation screenshots for manipulation patterns with AI-powered insights." />
  <style>
    /* ============ Design System ============ */
    :root{
      --bg-primary:#fafbfc; --bg-secondary:#fff; --bg-tertiary:#f5f7fa; --bg-accent:#f0f4ff;
      --text-primary:#1a1d29; --text-secondary:#4a5568; --text-muted:#718096; --text-inverse:#fff;
      --border-light:#e2e8f0; --border-medium:#cbd5e0; --border-focus:#4299e1;
      --accent:#4299e1; --accent-dark:#2b6cb0; --success:#38a169; --warning:#ed8936; --danger:#e53e3e;
      --shadow-sm:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);
      --shadow-md:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);
      --radius-md:10px; --radius-lg:14px;
      --font-sans:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      --font-mono:ui-monospace,SFMono-Regular,"SF Mono",Consolas,"Liberation Mono",Menlo,monospace;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg-primary);color:var(--text-primary);font-family:var(--font-sans);line-height:1.6}
    .container{max-width:1200px;margin:0 auto;padding:0 24px}
    .section{margin:32px 0}
    .card{background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);overflow:hidden}
    .card-header{padding:24px 24px 0}
    .card-body{padding:24px}
    .card-footer{padding:0 24px 24px;border-top:1px solid var(--border-light);margin-top:24px;padding-top:24px}
    h1{margin:0;font-size:2.4rem;font-weight:800;letter-spacing:-.02em;background:linear-gradient(135deg,var(--accent),var(--accent-dark));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    h2{margin:0 0 12px;font-size:1.45rem}
    .text-sm{font-size:.9rem;color:var(--text-muted)} .text-xs{font-size:.78rem;color:var(--text-muted)}
    .header{background:linear-gradient(135deg,var(--bg-secondary),var(--bg-accent));border-bottom:1px solid var(--border-light);padding:28px 0}
    .header-content{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .brand-icon{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px}
    .status-indicator{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#fff;border:1px solid var(--border-light);border-radius:10px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--success)}

    /* Upload zone */
    .upload-zone{border:2px dashed var(--border-medium);border-radius:16px;padding:42px 20px;text-align:center;background:var(--bg-tertiary);cursor:pointer;transition:.2s}
    .upload-zone:hover,.upload-zone.drag-over{border-color:var(--accent);background:var(--bg-accent);transform:translateY(-2px)}
    .upload-icon{width:64px;height:64px;margin:0 auto 12px;background:var(--accent);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px}
    .file-input{display:none}

    /* Forms & buttons */
    .form-group{margin:18px 0}
    .form-label{display:block;font-weight:600;margin-bottom:8px}
    .form-textarea,.form-select{width:100%;padding:12px 14px;border:1px solid var(--border-medium);border-radius:10px;background:#fff}
    .form-textarea:focus,.form-select:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 3px rgba(66,153,225,.12)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 22px;border:1px solid transparent;border-radius:10px;font-weight:600;background:#fff;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-primary:hover{background:var(--accent-dark);box-shadow:var(--shadow-md);transform:translateY(-1px)}
    .btn-secondary{border-color:var(--border-medium)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-lg{padding:16px 28px}
    .btn-sm{padding:8px 14px;font-size:.9rem}

    /* Progress */
    .progress{margin:16px 0;padding:16px;background:var(--bg-accent);border:1px solid var(--border-light);border-radius:12px}
    .steps{display:flex;gap:16px;margin-top:10px}
    .step{color:var(--text-muted)} .step.active{color:var(--accent)} .step.done{color:var(--success)}

    /* Results list */
    .result-card{background:#fff;border:1px solid var(--border-light);border-radius:16px;margin-bottom:20px;box-shadow:var(--shadow-sm);overflow:hidden}
    .result-header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border-light);background:var(--bg-tertiary)}
    .result-status{padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:700;letter-spacing:.04em}
    .status-complete{background:#d1fae5;color:#065f46}
    .status-processing{background:#e6fffa;color:#065f46}
    .status-error{background:#fee2e2;color:#991b1b}

    /* Tabs */
    .tabs{display:flex;border-bottom:1px solid var(--border-light);gap:8px;margin-bottom:16px}
    .tab{padding:10px 16px;background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;color:var(--text-muted);font-weight:600}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}

    /* Risk ring */
    .risk-display{display:flex;gap:28px;align-items:center;margin:18px 0}
    .risk-circle{position:relative;width:120px;height:120px}
    .risk-value{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:800}

    .metric{display:flex;justify-content:space-between;border-bottom:1px solid var(--border-light);padding:12px 0}
    .metric:last-child{border-bottom:none}
    .metric-label{font-weight:600}
    .metric-value{font-weight:700;color:var(--accent)}

    /* Tactic chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{border:1px solid var(--border-light);border-radius:999px;padding:6px 10px;background:#f8fafc;font-size:.85rem}

    /* Narrative & spectrum */
    .block{margin:14px 0}
    .spectrum{margin-top:8px}
    .srow{display:flex;align-items:center;gap:10px;margin:8px 0}
    .srow .lbl{width:200px;min-width:140px;font-weight:700}
    .meter{position:relative;flex:1;height:12px;background:#eef2f7;border:1px solid var(--border-light);border-radius:999px;overflow:hidden}
    .meter .fill{position:absolute;left:0;top:0;bottom:0;background:#4299e133}
    .meter .caret{position:absolute;top:-4px;width:2px;height:20px;background:#2b6cb0}
    .scale{display:flex;justify-content:space-between;font-size:.75rem;color:var(--text-muted);margin-top:4px}

    @media (max-width:760px){
      .header-content{flex-direction:column;text-align:center}
      .srow .lbl{width:140px}
      .btn{width:100%;justify-content:center}
      .risk-display{flex-direction:column;text-align:center}
    }
  </style>
</head>
<body>
  <!-- ============ Header ============ -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="brand">
          <div class="brand-icon">‚öóÔ∏è</div>
          <div>
            <h1>Toxella</h1>
            <div class="text-sm">Communication Analysis Platform</div>
          </div>
        </div>
        <div class="status-indicator">
          <div class="status-dot"></div>
          <span id="statusText">System Ready</span>
          <span class="text-xs" id="apiBaseLabel" style="margin-left:10px"></span>
        </div>
      </div>
    </div>
  </header>

  <!-- ============ Main ============ -->
  <main class="container">
    <!-- Uploader -->
    <section class="section">
      <div class="card">
        <div class="card-header">
          <h2>Analyze Conversation Screenshots</h2>
          <p class="text-sm">Upload 2‚Äì3 screenshots (JPG/PNG). Files auto-delete after analysis.</p>
        </div>
        <div class="card-body">
          <div class="upload-zone" id="dropzone" tabindex="0" aria-label="Upload screenshots">
            <div class="upload-icon">üì±</div>
            <div>Drop screenshots here or click to browse</div>
            <div class="text-sm" style="margin-bottom:12px">Max 3 files ‚Ä¢ Free plan: 1 report/session</div>
            <input id="fileInput" class="file-input" type="file" accept="image/*" multiple>
            <label for="fileInput" class="btn btn-primary" id="chooseBtn">Choose Files</label>
          </div>

          <div id="progress" class="progress" style="display:none">
            <div><strong>Working‚Ä¶</strong> <span id="progressText" class="text-sm">Initializing</span></div>
            <div class="steps">
              <div id="step-upload" class="step">üì§ Upload</div>
              <div id="step-analyze" class="step">üîç Analyze</div>
              <div id="step-report" class="step">üìä Report</div>
            </div>
          </div>

          <div class="grid" style="display:grid;gap:18px;grid-template-columns:1fr 1fr">
            <div class="form-group">
              <label class="form-label" for="context">Additional Context (optional)</label>
              <textarea id="context" class="form-textarea" placeholder="E.g., 'Dad denies late-night call, flips blame, says I‚Äôm crazy.'"></textarea>
              <div class="text-sm">Helps sharpen the narrative.</div>
            </div>
            <div class="form-group">
              <label class="form-label" for="method">Upload method</label>
              <select id="method" class="form-select">
                <option value="signed" selected>Automatic (recommended)</option>
                <option value="manual">Manual (CLI)</option>
              </select>
              <div class="text-sm">Use manual if automatic upload fails.</div>
            </div>
          </div>

          <details id="advanced" style="margin-top:10px">
            <summary class="btn btn-secondary btn-sm" style="display:inline-block">Show Advanced (CLI)</summary>
            <div class="text-sm" style="margin:10px 0">Run these if automatic upload fails, then click ‚ÄúI Ran Commands ‚Äî Start Polling‚Äù.</div>
            <pre id="cliBlock" class="text-xs" style="background:#f3f6fb;border:1px solid var(--border-light);padding:14px;border-radius:12px;white-space:pre-wrap"></pre>
            <div style="display:flex;gap:10px;margin-top:8px">
              <button id="copyCli" class="btn btn-secondary btn-sm" type="button">Copy Commands</button>
              <button id="confirmCli" class="btn btn-primary btn-sm" type="button">I Ran Commands ‚Äî Start Polling</button>
            </div>
          </details>
        </div>
        <div class="card-footer" style="display:flex;align-items:center;justify-content:space-between">
          <button id="generateBtn" class="btn btn-primary btn-lg" type="button">Generate Analysis Report</button>
          <div class="text-sm">By continuing you agree to our Terms & Privacy</div>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="section">
      <div class="card">
        <div class="card-header" style="display:flex;align-items:center;justify-content:space-between">
          <h2>Analysis Results</h2>
          <button id="deleteAll" class="btn btn-danger btn-sm" type="button">Clear All Results</button>
        </div>
        <div class="card-body">
          <div id="results">
            <div id="resultsPlaceholder" class="text-sm" style="text-align:center;padding:48px 0;color:var(--text-muted)">
              No analyses yet. Upload screenshots above to get started.
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Result Template -->
  <template id="resultTpl">
    <div class="result-card">
      <div class="result-header">
        <div style="display:flex;align-items:center;gap:12px">
          <div>
            <div style="font-weight:700">Analysis Report</div>
            <div class="text-xs" style="font-family:var(--font-mono)"><span class="job-id"></span></div>
          </div>
          <div class="result-status job-status status-processing">PROCESSING</div>
        </div>
        <button class="btn btn-secondary btn-sm btn-delete" type="button">Delete</button>
      </div>
      <div class="card-body">
        <div class="tabs">
          <button class="tab tab-sum active" type="button">Summary</button>
          <button class="tab tab-det" type="button">Detailed Report</button>
          <button class="tab tab-raw" type="button">Raw Data</button>
        </div>

        <!-- Summary -->
        <div class="sum-view">
          <div class="risk-display">
            <div class="ring-wrap"></div>
            <div style="flex:1">
              <div class="metric"><span class="metric-label">Analysis Confidence</span><span class="metric-value conf-val">‚Äî</span></div>
              <div class="metric"><span class="metric-label">Communication Balance</span><span class="metric-value cb-val">‚Äî</span></div>
              <div class="metric"><span class="metric-label">Emotional Stability</span><span class="metric-value es-val">‚Äî</span></div>
            </div>
          </div>
          <div class="chips tactic-chips"></div>
          <details style="margin-top:10px">
            <summary class="btn btn-secondary btn-sm" type="button">View Evidence Quotes</summary>
            <ul class="receipts-list" style="margin-top:10px"></ul>
          </details>
        </div>

        <!-- Detailed -->
        <div class="det-view" style="display:none">
          <div style="display:flex;gap:10px;margin-bottom:12px">
            <button class="btn btn-secondary btn-sm btn-copy" type="button">Copy Report</button>
            <button class="btn btn-secondary btn-sm btn-dl" type="button">Download .txt</button>
          </div>
          <div class="narrative"></div>
        </div>

        <!-- Raw -->
        <div class="raw-view" style="display:none">
          <pre class="raw-json text-xs" style="background:#f3f6fb;border:1px solid var(--border-light);padding:14px;border-radius:12px;white-space:pre-wrap"></pre>
        </div>
      </div>
    </div>
  </template>

  <script>
    /* ============ Config ============ */
    const DEFAULT_API = "https://toxella-api-yhopcbvaia-uc.a.run.app";
    const API_BASE = new URLSearchParams(location.search).get("api") || DEFAULT_API;
    const BUCKET = "toxella-id-uploads";
    const FREE_MAX_JOBS = 1, MAX_FILES = 3;

    /* ============ Elements ============ */
    const $status = document.getElementById('statusText');
    const $api = document.getElementById('apiBaseLabel');
    const $dz = document.getElementById('dropzone');
    const $fileInput = document.getElementById('fileInput');
    const $context = document.getElementById('context');
    const $advanced = document.getElementById('advanced');
    const $cliBlock = document.getElementById('cliBlock');
    const $copyCli = document.getElementById('copyCli');
    const $confirmCli = document.getElementById('confirmCli');
    const $generate = document.getElementById('generateBtn');
    const $progress = document.getElementById('progress');
    const $progressText = document.getElementById('progressText');
    const $results = document.getElementById('results');
    const $placeholder = document.getElementById('resultsPlaceholder');
    const $deleteAll = document.getElementById('deleteAll');
    const resultTpl = document.getElementById('resultTpl');

    let files = [], jobs = [], jobsCount = 0;

    /* ============ Init ============ */
    $api.textContent = API_BASE;

    // Drag & drop
    ['dragenter','dragover'].forEach(ev => $dz.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();$dz.classList.add('drag-over');}));
    ['dragleave','drop'].forEach(ev => $dz.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation();$dz.classList.remove('drag-over');}));
    $dz.addEventListener('drop', e=>handleFiles(e.dataTransfer.files));
    // Click anywhere in the zone (label already triggers natively)
    $dz.addEventListener('click', e=>{ if (!e.target.closest('label')) $fileInput.click(); });
    $fileInput.addEventListener('change', e=>handleFiles(e.target.files));

    function handleFiles(list){
      files = Array.from(list || []).slice(0, MAX_FILES);
      setStatus(`${files.length} file(s) selected`);
      if ($advanced.open) renderCLI();
    }

    function setStatus(s){ $status.textContent = s; }
    function setProgress(step, text){
      $progressText.textContent = text;
      const map = {upload: 'step-upload', analyze:'step-analyze', report:'step-report'};
      for (const k of Object.values(map)){ document.getElementById(k).className = 'step'; }
      if (map[step]){
        if (step === 'analyze'){ document.getElementById('step-upload').classList.add('done'); }
        if (step === 'report'){ document.getElementById('step-upload').classList.add('done'); document.getElementById('step-analyze').classList.add('done'); }
        document.getElementById(map[step]).classList.add('active');
      }
    }

    /* ============ CLI Fallback ============ */
    function renderCLI(){
      if (!files.length){ $cliBlock.textContent = '# Select files first'; return; }
      const D='$';
      const names = files.map(f=>`"${f.name}"`).join(' ');
      const fileJsons = files.map((f,i)=>`{"path":"uploads/${D}JOB_ID/${i}.jpg"}`).join(',');
      $cliBlock.textContent =
`# macOS/Linux
API="${API_BASE}"
BUCKET="${BUCKET}"
JOB_ID="$(uuidgen 2>/dev/null || python3 -c 'import uuid;print(uuid.uuid4())')"
echo "JOB_ID=${D}JOB_ID"

i=0; for f in ${names}; do
  gsutil cp "\${f}" "gs://${D}BUCKET/uploads/${D}JOB_ID/${D}i.jpg"; i=$((i+1));
done

curl -sS -X POST "${D}API/jobs" -H "Content-Type: application/json" -d '{
  "jobId":"'"${D}JOB_ID"'","plan":"free","files":[${fileJsons}],
  "instructions": ${JSON.stringify(JSON.stringify(($context.value||'').trim()))}
}'

watch -n 3 curl -sS "${D}API/jobs/${D}JOB_ID"

# Windows PowerShell
${D}Api="${API_BASE}"
${D}Bucket="${BUCKET}"
${D}JOB_ID=[guid]::NewGuid().Guid
"JOB_ID=${D}JOB_ID"
${files.map((f,i)=>`gsutil cp "${f.name}" "gs://${D}Bucket/uploads/${D}JOB_ID/${i}.jpg"`).join('\n')}
${D}JobJson=@"
{ "jobId":"${D}JOB_ID","plan":"free","files":[${fileJsons}],
  "instructions": ${JSON.stringify(($context.value||'').trim())}
}
"@
Invoke-RestMethod -Method POST -Uri "${D}Api/jobs" -ContentType "application/json" -Body ${D}JobJson
while(${D}true){ curl "${D}Api/jobs/${D}JOB_ID"; Start-Sleep 3 }`;
    }
    $advanced.addEventListener('toggle', ()=>{ if ($advanced.open) renderCLI(); });
    $copyCli.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText($cliBlock.textContent); setStatus('CLI copied'); }catch{ setStatus('Copy failed'); } });
    $confirmCli.addEventListener('click', ()=>{ const id = prompt('Paste the JOB_ID from your terminal:'); if (id) addResultCard(id); });

    /* ============ Generate Flow ============ */
    document.getElementById('generateBtn').addEventListener('click', async ()=>{
      try{
        if (jobsCount >= FREE_MAX_JOBS) return setStatus('Free plan limit reached. Clear results to run again.');
        if (files.length < 2) return setStatus('Please select at least 2 screenshots.');
        if (files.length > MAX_FILES) return setStatus(`Maximum ${MAX_FILES} files allowed.`);

        $progress.style.display = 'block';
        setProgress('upload','Requesting upload slots‚Ä¶');

        const r = await fetch(`${API_BASE}/signed-urls`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ plan:'free', count: files.length })
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || 'Upload request failed');

        const { jobId, urls=[] } = j;
        if (!jobId || urls.length < files.length) throw new Error('Server did not provide enough upload slots');

        // Upload
        setProgress('upload','Uploading screenshots‚Ä¶');
        const metas = [];
        for (let i=0;i<files.length;i++){
          const f = files[i], u = urls[i];
          const ct = u.contentType || f.type || 'application/octet-stream';
          const put = await fetch(u.uploadUrl, { method:'PUT', headers:{'Content-Type':ct}, body:f });
          if (!put.ok) throw new Error(`Upload failed for ${f.name} (${put.status})`);
          metas.push({ path:u.path, size:f.size, mime:f.type || ct });
        }

        // Create job
        setProgress('analyze','Creating analysis job‚Ä¶');
        const instructions = ($context.value||'').trim();
        const cr = await fetch(`${API_BASE}/jobs`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ jobId, plan:'free', files: metas, ...(instructions?{instructions}:{}) })
        });
        const cj = await cr.json();
        if (!cr.ok) throw new Error(cj.error || 'Job creation failed');

        setProgress('report','Analysis in progress‚Ä¶');
        addResultCard(jobId);
        jobsCount++;
        setStatus('Analysis started. You can keep this page open.');
      }catch(e){
        console.error(e);
        setStatus(e.message || 'Something went wrong');
        $progress.style.display = 'none';
      }
    });

    /* ============ Results Rendering ============ */
    function addResultCard(jobId){
      const frag = resultTpl.content.cloneNode(true);
      const el = frag.children[0];
      el.querySelector('.job-id').textContent = jobId;
      const $statusEl = el.querySelector('.job-status');
      const $btnDel = el.querySelector('.btn-delete');
      const tabs = el.querySelectorAll('.tab');
      const $sum = el.querySelector('.sum-view'), $det = el.querySelector('.det-view'), $raw = el.querySelector('.raw-view');
      const $rawJson = el.querySelector('.raw-json');
      const $ring = el.querySelector('.ring-wrap');
      const $chips = el.querySelector('.tactic-chips');
      const $receipts = el.querySelector('.receipts-list');
      const $narr = el.querySelector('.narrative');

      tabs.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          tabs.forEach(t=>t.classList.remove('active')); btn.classList.add('active');
          $sum.style.display = btn.classList.contains('tab-sum') ? 'block':'none';
          $det.style.display = btn.classList.contains('tab-det') ? 'block':'none';
          $raw.style.display = btn.classList.contains('tab-raw') ? 'block':'none';
        });
      });

      $btnDel.addEventListener('click', async ()=>{
        try{ await fetch(`${API_BASE}/jobs/${encodeURIComponent(jobId)}`, { method:'DELETE' }); }catch{}
        el.remove(); jobs = jobs.filter(j=>j.id!==jobId); setStatus('Job deleted');
      });

      if ($placeholder) $placeholder.style.display = 'none';
      $results.prepend(el);

      async function poll(){
        try{
          const jr = await fetch(`${API_BASE}/jobs/${encodeURIComponent(jobId)}`, { cache:'no-store' });
          const j = await jr.json();
          const st = (j.status||'').toUpperCase();
          $statusEl.textContent = st || 'PENDING';
          $statusEl.className = 'result-status job-status ' + (st.includes('COMPLETE')?'status-complete': st.includes('ERROR')?'status-error':'status-processing');

          if (j.reportId){
            const rr = await fetch(`${API_BASE}/reports/${encodeURIComponent(j.reportId)}`, { cache:'no-store' });
            const rep = await rr.json();
            $rawJson.textContent = JSON.stringify(rep, null, 2);

            // Risk ring
            const score = toInt(rep.risk_score ?? rep.analysis?.risk_score ?? rep.score ?? 0);
            $ring.innerHTML = ring(score);

            // Metrics
            const conf = rep.confidence ?? rep.analysis?.confidence ?? null;
            el.querySelector('.conf-val').textContent = toPct(conf);

            const cb = firstNumber(rep.kpis?.communication_balance, rep.analysis?.kpis?.communication_balance, rep.analysis?.communication_balance);
            const es = firstNumber(rep.kpis?.emotional_stability, rep.analysis?.kpis?.emotional_stability, rep.analysis?.emotional_stability);
            if (typeof cb === 'number') el.querySelector('.cb-val').textContent = `${Math.round(cb)} / 100`;
            if (typeof es === 'number') el.querySelector('.es-val').textContent = `${Math.round(es)} / 100`;

            // Tactic chips
            const tactics = Array.isArray(rep.tactics)?rep.tactics:[];
            $chips.innerHTML = tactics.slice(0,6).map(t=>{
              const name=(t.name||t.id||t).toString();
              let raw=(typeof t.score==='number'?t.score:(typeof t.likelihood==='number'?t.likelihood:null));
              const val = raw==null?'':(raw<=1?Math.round(raw*100):Math.round(raw));
              return `<span class="chip">${escapeHtml(name)}${val!==''?` ‚Ä¢ ${val}`:''}</span>`;
            }).join('') || `<span class="text-sm">No tactics extracted</span>`;

            // Receipts (flat list)
            const recs = rep?.receipts?.highlights || rep?.receipts || [];
            $receipts.innerHTML = recs.slice(0,12).map(r=>{
              const q = (r.quote || r || '').toString().slice(0,280);
              const cat = r.category || r.tactic || '';
              return `<li>‚Äú${escapeHtml(q)}‚Äù <span class="text-xs" style="margin-left:6px;color:#6b7280">${escapeHtml(cat)}</span></li>`;
            }).join('') || `<li class="text-sm">No quotes extracted</li>`;

            // Detailed narrative
            $narr.innerHTML = buildPremiumReport(rep);

            // Copy/Download
            const $copy = el.querySelector('.btn-copy');
            const $dl = el.querySelector('.btn-dl');
            if ($copy) $copy.onclick = async()=>{ await navigator.clipboard.writeText($narr.innerText.trim()); setStatus('Report copied'); };
            if ($dl) $dl.onclick = ()=>{ const blob = new Blob([$narr.innerText],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`toxella_report_${jobId}.txt`; a.click(); URL.revokeObjectURL(a.href); };

            $progress.style.display = 'none';
            setStatus('Analysis complete');
            return;
          }
          if (st.includes('ERROR')){ $progress.style.display = 'none'; setStatus('Analysis failed'); return; }
        }catch(e){ /* transient */ }
        setTimeout(poll, 2500);
      }
      poll();
      jobs.push({id:jobId, el});
    }

    // Delete all
    $deleteAll.addEventListener('click', async ()=>{
      for (const j of jobs){ try{ await fetch(`${API_BASE}/jobs/${encodeURIComponent(j.id)}`, {method:'DELETE'}); }catch{} }
      $results.innerHTML = '<div id="resultsPlaceholder" class="text-sm" style="text-align:center;padding:48px 0;color:#718096">No analyses yet. Upload screenshots above to get started.</div>';
      jobs=[]; jobsCount=0; setStatus('All results cleared');
    });

    /* ============ Helpers ============ */
    function ring(score){
      const pct = Math.max(0,Math.min(100,Math.round(score||0)));
      const r=45,c=2*Math.PI*r,d=(pct/100)*c; let col='#38a169'; if (pct>=67) col='#e53e3e'; else if (pct>=34) col='#ed8936';
      return `<svg class="risk-circle" viewBox="0 0 120 120" role="img" aria-label="Risk ${pct}/100">
        <circle cx="60" cy="60" r="${r}" stroke="#e2e8f0" stroke-width="8" fill="none"/>
        <circle cx="60" cy="60" r="${r}" stroke="${col}" stroke-width="8" fill="none" stroke-dasharray="${d} ${c-d}" stroke-linecap="round" transform="rotate(-90 60 60)"/>
        <g class="risk-value"><text x="60" y="64" text-anchor="middle">${pct}</text></g>
      </svg>`;
    }
    function toInt(x){ if (typeof x==='number') return Math.round(x<=1?x*100:x); if (typeof x==='string' && /^\d+$/.test(x)) return parseInt(x,10); return 0; }
    function toPct(x){ if (typeof x==='number') return `${Math.round(x<=1?x*100:x)}%`; if (typeof x==='string' && /^\d+%$/.test(x)) return x; return '‚Äî'; }
    function firstNumber(...vals){ for (const v of vals){ if (typeof v==='number' && !isNaN(v)) return v; } return null; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    /* ============ Premium Narrative Builder ============ */
    const TACTIC_ORDER = ["gaslighting","darvo","blame-shifting","minimization","stonewalling","contempt","guilt-tripping","threats","coercion","triangulation","boundaries","projection"];
    const TACTIC_NAME = {
      "gaslighting":"Gaslighting",
      "darvo":"DARVO (Deny, Attack, Reverse Victim/Offender)",
      "blame-shifting":"Blame-shifting",
      "minimization":"Minimization",
      "stonewalling":"Stonewalling",
      "contempt":"Contempt / Insults",
      "guilt-tripping":"Guilt-tripping",
      "threats":"Threats",
      "coercion":"Coercion / Control",
      "triangulation":"Triangulation",
      "boundaries":"Boundary Misuse",
      "projection":"Projection"
    };
    const TACTIC_DESC = {
      "gaslighting":"Denies or distorts reality to make you doubt your memory, perception, or sanity.",
      "darvo":"Flips roles: denies harm, attacks the accuser, and claims to be the real victim.",
      "blame-shifting":"Redirects responsibility back onto you or others.",
      "minimization":"Downplays the seriousness of events/feelings to avoid accountability.",
      "stonewalling":"Refuses to engage or delays to block resolution.",
      "contempt":"Mocks, belittles, or insults; communicates superiority or disgust.",
      "guilt-tripping":"Uses guilt to coerce compliance when you did not do wrong.",
      "threats":"Explicit or implied threats to punish, harm, or abandon.",
      "coercion":"Controls choices through pressure, ultimatums, or consequences.",
      "triangulation":"Pulls in third parties to intimidate or discredit.",
      "boundaries":"Invokes ‚Äòboundaries‚Äô selectively to dodge accountability or control access.",
      "projection":"Accuses you of the very behavior they‚Äôre doing."
    };
    function normId(x){
      const s = String(x||'').toLowerCase();
      if (s.includes('boundary')) return 'boundaries';
      if (s.includes('guilt')) return 'guilt-tripping';
      if (s.includes('insult')||s.includes('contempt')) return 'contempt';
      if (s.includes('threat')) return 'threats';
      if (s.includes('coerc')) return 'coercion';
      if (s.includes('minim')) return 'minimization';
      if (s.includes('stone')) return 'stonewalling';
      if (s.includes('triang')) return 'triangulation';
      if (s.includes('shift')) return 'blame-shifting';
      return s;
    }
    function synthScore(t){
      const p = Math.max(0, Math.min(1, t.likelihood ?? 0));
      const s = Math.max(1, Math.min(5, t.severity ?? 3));
      const f = Math.max(0, Math.min(5, t.frequency ?? (t.examples?.length||0)));
      return Math.round(40*p + 35*((s-1)/4) + 25*Math.min(1,f/5));
    }
    function scoreFor(tactics, id){
      const t = (tactics||[]).find(x => normId(x.id||x.name) === id);
      if (!t) return 0;
      if (typeof t.score === 'number') return Math.max(0, Math.min(100, Math.round(t.score<=1?t.score*100:t.score)));
      return synthScore(t);
    }
    function receiptsByTactic(rep){
      const out={};
      const recs = rep?.receipts?.highlights || rep?.receipts || [];
      for (const r of recs){
        const cat = normId(r.category || r.tactic || '');
        const q = (r.quote || r || '').toString().trim();
        if (!q) continue;
        (out[cat] ||= []).push(q.slice(0,280));
      }
      for (const t of (rep.tactics||[])){
        const id = normId(t.id||t.name);
        if (!out[id] && t.examples?.length) out[id] = t.examples.map(x=>String(x).slice(0,280));
      }
      return out;
    }
    function spectrumRow(label, score){
      const pct = Math.max(0,Math.min(100,Math.round(score)));
      return `<div class="srow">
        <div class="lbl">${escapeHtml(label)}</div>
        <div class="meter" role="meter" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${pct}">
          <div class="fill" style="width:${pct}%"></div>
          <div class="caret" style="left:calc(${pct}% - 1px)"></div>
        </div>
      </div>`;
    }
    function buildPremiumReport(rep){
      const score = toInt(rep.risk_score ?? rep.analysis?.risk_score ?? rep.score ?? 0);
      const label = (rep.risk_label || (score<34?'low':score<=66?'medium':'high')).toUpperCase();
      const confPct = toPct(rep.confidence ?? rep.analysis?.confidence ?? 0.85);
      const cb = firstNumber(rep.kpis?.communication_balance, rep.analysis?.kpis?.communication_balance, rep.analysis?.communication_balance);
      const es = firstNumber(rep.kpis?.emotional_stability, rep.analysis?.kpis?.emotional_stability, rep.analysis?.emotional_stability);

      let html = `<div class="block"><h3>Scores</h3><ul>
        <li>Manipulation Risk: <strong>${score} / 100 (${label})</strong></li>
        ${typeof cb==='number'?`<li>Communication Balance: <strong>${Math.round(cb)} / 100</strong></li>`:''}
        ${typeof es==='number'?`<li>Emotional Stability: <strong>${Math.round(es)} / 100</strong></li>`:''}
        <li>Confidence: <strong>${confPct}</strong></li>
      </ul></div>`;

      // Spectrum
      let spectrum = '';
      const tScores=[];
      for (const id of TACTIC_ORDER){ const s = scoreFor(rep.tactics, id); tScores.push({id,score:s}); spectrum += spectrumRow(TACTIC_NAME[id], s); }
      html += `<div class="block"><h3>Tactic Spectrum</h3><div class="spectrum">${spectrum}</div>
        <div class="scale"><span>None</span><span>Low</span><span>Medium</span><span>High</span><span>Severe</span></div></div>`;

      // Top tactics
      const top = tScores.slice().sort((a,b)=>b.score-a.score).slice(0,3).filter(t=>t.score>0);
      html += `<div class="block"><h3>Top Tactics (what it looks like)</h3>`;
      if (!top.length){
        html += `<p class="text-sm">No strong manipulation indicators detected; language may still be tense.</p>`;
      } else {
        const grouped = receiptsByTactic(rep);
        for (const t of top){
          const id=t.id, name=TACTIC_NAME[id], ex=(grouped[id]||[]).slice(0,4);
          html += `<div class="block">
            <div style="display:flex;align-items:center;gap:10px"><strong>${escapeHtml(name)}</strong>
              <span class="result-status status-processing" style="padding:3px 8px;border-radius:999px">${t.score}/100</span>
            </div>
            <div class="text-sm" style="margin:6px 0">${escapeHtml(TACTIC_DESC[id])}</div>
            ${ex.length?`<ul>${ex.map(q=>`<li>‚Äú${escapeHtml(q)}‚Äù</li>`).join('')}</ul>`:`<div class="text-sm">Signals present, no quotable snippets extracted.</div>`}
          </div>`;
        }
      }
      html += `</div>`;

      // Summary paragraph
      html += `<div class="block"><h3>Summary</h3>
        <p>This conversation shows ${label==='HIGH'?'severe':label==='MEDIUM'?'elevated':'low'} manipulation risk. The most salient patterns are
        ${top.length? top.map(t=>escapeHtml(TACTIC_NAME[t.id])).join(', '):'no strong tactics'}.
        Use the receipts below as evidence, and consider calm boundary-setting responses.</p></div>`;

      // Grouped receipts
      const grouped = receiptsByTactic(rep);
      html += `<div class="block"><h3>Receipts (flagged quotes, grouped)</h3>`;
      const any = Object.keys(grouped).some(k => (grouped[k]||[]).length);
      if (!any){ html += `<p class="text-sm">No quotable receipts were extracted.</p>`; }
      else {
        for (const id of TACTIC_ORDER){
          const arr = grouped[id]; if (!arr || !arr.length) continue;
          html += `<h4 style="margin:10px 0 4px">${escapeHtml(TACTIC_NAME[id])}</h4>
                   <ul>${arr.map(q=>`<li>‚Äú${escapeHtml(q)}‚Äù</li>`).join('')}</ul>`;
        }
      }
      html += `</div>`;

      // Suggestions
      html += `<div class="block"><h3>Suggested Responses (non-escalating)</h3>
        <ul>
          <li>‚ÄúCalling me names doesn‚Äôt address the question. Can you answer directly?‚Äù</li>
          <li>‚ÄúLet‚Äôs stay with this specific event. I‚Äôm asking about that.‚Äù</li>
          <li>‚ÄúIf we can‚Äôt talk respectfully right now, let‚Äôs pause and revisit later.‚Äù</li>
        </ul></div>`;

      return html;
    }
  </script>
</body>
</html>
