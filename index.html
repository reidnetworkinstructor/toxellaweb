<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Toxella ‚Äî Communication Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Analyze conversation screenshots for manipulation patterns with AI-powered insights." />
  <style>
    :root{
      --bg:#f7f9fc; --panel:#ffffff; --ink:#101828; --muted:#667085; --subtle:#98a2b3;
      --line:#e5e7eb; --line-2:#d0d5dd;
      --acc:#3b82f6; --acc-2:#1d4ed8;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --chip:#f2f4f7; --ring:#e5e7eb;
      --shadow:0 2px 12px rgba(16,24,40,.06);
      --r-sm:10px; --r-lg:16px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      --sans:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:var(--sans);line-height:1.6}
    .container{max-width:1100px;margin:0 auto;padding:0 20px}
    h1{font-size:2.2rem;margin:0;background:linear-gradient(135deg,var(--acc),var(--acc-2));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800;letter-spacing:-.02em}
    h2{font-size:1.4rem;margin:0 0 8px}
    .text-sm{font-size:.92rem;color:var(--muted)} .text-xs{font-size:.8rem;color:var(--subtle)}
    .header{background:linear-gradient(180deg,#fff,#f8fbff);border-bottom:1px solid var(--line)}
    .header-content{display:flex;align-items:center;justify-content:space-between;padding:22px 0;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--acc),var(--acc-2));color:#fff;display:grid;place-items:center;font-size:22px;box-shadow:var(--shadow)}
    .ready{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#fff;border:1px solid var(--line);border-radius:10px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--ok)}
    .toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;max-width:92vw;z-index:9999}
    .toast .t{background:#111827;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:var(--shadow);font-size:.92rem}
    .t.ok{background:#166534}.t.warn{background:#92400e}.t.err{background:#7f1d1d}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--r-lg);box-shadow:var(--shadow);overflow:hidden;margin:28px 0}
    .card-h{padding:22px 22px 0}
    .card-b{padding:22px}
    .card-f{padding:12px 22px 22px;border-top:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .drop{border:2px dashed var(--line-2);border-radius:16px;background:#f8fafc;padding:36px;text-align:center;cursor:pointer;transition:.15s}
    .drop:hover,.drop.drag{border-color:var(--acc);background:#eef5ff;transform:translateY(-1px)}
    .drop .icon{width:58px;height:58px;border-radius:50%;background:var(--acc);color:#fff;display:grid;place-items:center;margin:0 auto 10px;font-size:22px}
    .gallery{margin-top:16px;display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(230px,1fr))}
    .file{display:flex;gap:12px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
    .thumb{width:56px;height:56px;border-radius:10px;background:#f2f4f7;border:1px solid var(--line);overflow:hidden;display:grid;place-items:center;font-size:18px;color:var(--muted)}
    .thumb img{display:block;max-width:100%;max-height:100%}
    .meta{flex:1;min-width:0}
    .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600}
    .stat{font-size:.82rem;color:var(--muted)}
    .visually-hidden{position:absolute!important;left:-9999px!important;width:1px!important;height:1px!important;overflow:hidden!important}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 18px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn:hover{box-shadow:var(--shadow)}
    .primary{background:var(--acc);color:#fff;border-color:transparent}
    .primary:hover{background:var(--acc-2)}
    .danger{background:var(--bad);color:#fff;border-color:transparent}
    .btn-sm{padding:8px 12px;font-size:.92rem}
    .input,.textarea{width:100%;padding:12px 14px;border:1px solid var(--line-2);border-radius:10px;background:#fff}
    .textarea:focus,.input:focus{outline:none;border-color:var(--acc);box-shadow:0 0 0 3px rgba(59,130,246,.12)}
    label{font-weight:600;display:block;margin:10px 0 6px}
    .steps{display:flex;gap:14px;flex-wrap:wrap;margin-top:10px}
    .step{color:var(--subtle)}
    .step.active{color:var(--acc)} .step.done{color:var(--ok)}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);margin-bottom:12px}
    .tab{padding:10px 14px;background:none;border:none;border-bottom:2px solid transparent;font-weight:700;color:var(--muted);cursor:pointer}
    .tab.active{border-bottom-color:var(--acc);color:var(--acc)}
    .result{background:#fff;border:1px solid var(--line);border-radius:16px;margin:16px 0;overflow:hidden}
    .result-h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);background:#f8fafc}
    .badge{padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:700;letter-spacing:.04em}
    .ok{background:#dcfce7;color:#14532d} .warn{background:#fff7ed;color:#9a3412} .proc{background:#eff6ff;color:#1d4ed8}
    .risk{display:flex;gap:22px;align-items:center;flex-wrap:wrap}
    .ring{position:relative;width:120px;height:120px}
    .ring .val{position:absolute;inset:0;display:grid;place-items:center;font-size:1.5rem;font-weight:800}
    .metrics{flex:1;min-width:240px}
    .metric{display:flex;justify-content:space-between;border-bottom:1px solid var(--line);padding:10px 0}
    .metric:last-child{border-bottom:none}
    .metric .v{font-weight:800;color:var(--acc)}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .chip{border:1px solid var(--line);background:var(--chip);border-radius:999px;padding:6px 10px;font-size:.86rem}
    .compact{display:grid;gap:10px}
    .srow{display:flex;gap:10px;align-items:center;margin:8px 0}
    .srow .lbl{width:210px;min-width:150px;font-weight:700}
    .meter{position:relative;flex:1;height:12px;background:#eef2f7;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .fill{position:absolute;left:0;top:0;bottom:0;background:#3b82f633}
    .caret{position:absolute;top:-4px;width:2px;height:20px;background:#1d4ed8}
    .scale{display:flex;justify-content:space-between;font-size:.78rem;color:var(--subtle);margin-top:4px}
    pre{white-space:pre-wrap;background:#f3f6fb;border:1px solid var(--line);border-radius:12px;padding:12px;font-family:var(--mono);font-size:.86rem}
    .row{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    @media (max-width:820px){ .row{grid-template-columns:1fr} .srow .lbl{width:150px} .btn{width:100%;justify-content:center}}
  </style>
</head>
<body>
  <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

  <header class="header">
    <div class="container header-content">
      <div class="brand">
        <div class="logo" aria-hidden="true">‚öóÔ∏è</div>
        <div>
          <h1>Toxella</h1>
          <div class="text-sm">Communication Analysis ‚Äî Soft-launch MVP</div>
        </div>
      </div>
      <div class="ready" aria-live="polite">
        <span class="dot" aria-hidden="true"></span>
        <span id="statusText">System Ready</span>
        <span class="text-xs" id="apiBaseLabel" style="margin-left:8px"></span>
      </div>
    </div>
  </header>

  <main class="container" id="app">
    <!-- Upload -->
    <section class="card" aria-labelledby="upl-title">
      <div class="card-h">
        <h2 id="upl-title">Analyze Conversation Screenshots</h2>
        <p class="text-sm">Upload up to <strong>3</strong> images (JPG/PNG). Free plan: <strong>one</strong> report per session.</p>
      </div>
      <div class="card-b">
        <!-- Label triggers picker reliably -->
        <label id="dropzone" class="drop" tabindex="0" role="button" for="fileInput"
               aria-label="Upload screenshots (drop or click)">
          <div class="icon">üì±</div>
          <div><strong>Drop screenshots</strong> here or click to browse</div>
          <div class="text-xs" style="margin-top:6px">We use short-lived, v4 signed URLs and upload directly to secure storage.</div>
        </label>
        <input id="fileInput" type="file" accept="image/*" multiple class="visually-hidden" aria-hidden="true">

        <!-- File gallery -->
        <div id="gallery" class="gallery" aria-live="polite" aria-relevant="additions text"></div>

        <!-- Context -->
        <div class="row" style="margin-top:12px">
          <div>
            <label for="context">Optional context</label>
            <textarea id="context" class="textarea" rows="3" placeholder="E.g., ‚ÄúHe denies the midnight call, flips blame, calls me crazy.‚Äù Helps sharpen the narrative."></textarea>
          </div>
          <div>
            <label for="plan">Plan</label>
            <input id="plan" class="input" value="free" aria-readonly="true" readonly>
            <div class="text-xs" style="margin-top:6px">
              <!-- TODO: Stripe Pro CTA -->
              Want unlimited reports? <a href="#" aria-disabled="true" title="Coming soon">Pro (coming soon)</a>
            </div>
          </div>
        </div>

        <!-- Steps -->
        <div class="steps text-sm" id="steps" style="margin-top:10px">
          <span class="step" id="st-select">‚ë† Select</span>
          <span class="step" id="st-upload">‚ë° Upload</span>
          <span class="step" id="st-analyze">‚ë¢ Analyze</span>
          <span class="step" id="st-report">‚ë£ Report</span>
        </div>
      </div>
      <div class="card-f">
        <button id="generateBtn" class="btn primary" type="button" aria-label="Generate analysis report">
          <span class="btn-label">Generate Analysis Report</span>
        </button>
        <div class="text-sm">
          <!-- TODO: Terms/Privacy links -->
          By continuing you agree to our <a href="#" aria-disabled="true">Terms</a> & <a href="#" aria-disabled="true">Privacy</a>.
          <span class="text-xs" id="limitNote" style="margin-left:8px;color:var(--subtle)"></span>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="card" aria-labelledby="res-title">
      <div class="card-h" style="display:flex;align-items:center;justify-content:space-between">
        <h2 id="res-title">Analysis Results</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="clearBtn" class="btn btn-sm danger" type="button">Clear All (client-side)</button>
        </div>
      </div>
      <div class="card-b" id="results">
        <div id="empty" class="text-sm" style="text-align:center;padding:46px 0;color:var(--subtle)">No analyses yet. Upload screenshots above to get started.</div>
      </div>

      <!-- Optional dev samples -->
      <div class="card-f">
        <details>
          <summary class="text-sm">Dev Samples (JSON) ‚Äî paste into Raw tab while testing</summary>
          <pre class="text-xs" style="margin-top:8px">{ "analysis":{ "risk_score":18, "confidence":0.88 }, "kpis":{ "communication_balance":72, "emotional_stability":81 }, "tactics":[{"id":"minimization","likelihood":0.2}], "receipts":{"highlights":[{"quote":"Calm down, it was nothing.","tactic":"minimization"}]} }</pre>
          <pre class="text-xs">{ "risk_score":52, "confidence":"76%", "kpis":{ "communication_balance":55, "emotional_stability":47 }, "tactics":[{"name":"gaslighting","score":64,"examples":["You always misremember.","That's not how it happened."]},{"name":"blame-shifting","likelihood":0.55}], "receipts":[{"quote":"You're imagining it."},{"quote":"If you hadn't started it‚Ä¶","category":"blame-shifting"}] }</pre>
          <pre class="text-xs">{ "analysis":{ "risk_score":91, "confidence":0.93, "kpis":{ "communication_balance":22, "emotional_stability":18 } }, "tactics":[{"id":"darvo","likelihood":0.92,"examples":["Stop attacking me, I'm the victim."]},{"id":"threats","likelihood":0.88,"examples":["You'll regret this."]},{"id":"contempt","score":85}], "receipts":{"highlights":[{"quote":"You're the abusive one here.","tactic":"darvo"},{"quote":"Keep it up and see what happens.","tactic":"threats"}]} }</pre>
        </details>
      </div>
    </section>
  </main>

  <!-- Result Template -->
  <template id="resultTpl">
    <div class="result" role="region" aria-label="Analysis report">
      <div class="result-h">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="font-weight:800">Analysis Report</div>
          <div class="text-xs" style="font-family:var(--mono)">Job <span class="job-id"></span></div>
        </div>
        <div class="badge proc job-status">PROCESSING</div>
      </div>
      <div class="card-b">
        <div class="tabs" role="tablist">
          <button class="tab tab-sum active" role="tab" aria-selected="true" type="button">Summary</button>
          <button class="tab tab-det" role="tab" aria-selected="false" type="button">Detailed Report</button>
          <button class="tab tab-raw" role="tab" aria-selected="false" type="button">Raw Data</button>
        </div>

        <!-- Summary -->
        <div class="sum" role="tabpanel">
          <div class="risk">
            <div class="ring-wrap"></div>
            <div class="metrics">
              <div class="metric"><span>Risk Label</span><span class="v risk-label">‚Äî</span></div>
              <div class="metric"><span>Analysis Confidence</span><span class="v conf-val">‚Äî</span></div>
              <div class="metric"><span>Communication Balance</span><span class="v cb-val">‚Äî</span></div>
              <div class="metric"><span>Emotional Stability</span><span class="v es-val">‚Äî</span></div>
              <div class="metric"><span>Receipts</span><span class="v rc-val">‚Äî</span></div>
            </div>
          </div>

          <div class="chips tactic-chips" aria-label="Detected tactics"></div>

          <div class="compact">
            <h3 style="margin:6px 0 0">Top 3 tactics (quick view)</h3>
            <div class="top3"></div>
          </div>

          <details style="margin-top:8px">
            <summary class="btn btn-sm" type="button" aria-controls="receipts-list">View Evidence Quotes</summary>
            <ul class="receipts-list" id="receipts-list" style="margin-top:10px"></ul>
          </details>
        </div>

        <!-- Detailed -->
        <div class="det" style="display:none" role="tabpanel">
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
            <button class="btn btn-sm" data-copy type="button">Copy Report</button>
            <button class="btn btn-sm" data-download type="button">Download .txt</button>
          </div>
          <div class="narrative"></div>
        </div>

        <!-- Raw -->
        <div class="raw" style="display:none" role="tabpanel">
          <pre class="raw-json" aria-label="Raw JSON"></pre>
        </div>
      </div>
    </div>
  </template>

  <script>
    /* ==========================================================================================
       Toxella Frontend (single-file, vanilla JS). Signed URLs only. API base is hardcoded.
       Cloud Run base: https://toxella-api-yhopcbvaia-uc.a.run.app

       BACKEND CONTRACT (do not remove, used by ops)
       Endpoints:
         POST  /signed-urls  { plan, count } -> { jobId, urls:[{uploadUrl, path, contentType?}] }
         PUT   <signed-url>  (file body)
         POST  /jobs         { jobId, plan, files:[{path,size,mime}], instructions? }
         GET   /jobs/{id}    -> { status, reportId? }
         GET   /reports/{id} -> final JSON

       FIELD MAPPING ‚Äî If your worker payload changes, edit the accessors in:
         renderReportSummary() and buildPremiumReport()
         We read defensively from these keys:
           risk score: rep.risk_score OR rep.analysis.risk_score OR rep.score
           confidence: rep.confidence OR rep.analysis.confidence
           kpis.communication_balance: rep.kpis.communication_balance OR rep.analysis.kpis.communication_balance OR rep.analysis.communication_balance
           kpis.emotional_stability:   rep.kpis.emotional_stability   OR rep.analysis.kpis.emotional_stability   OR rep.analysis.emotional_stability
           tactics: rep.tactics[] (item: {id|name, score|likelihood, examples?})
           receipts: rep.receipts.highlights[] OR rep.receipts[] (item: {quote, tactic|category})
       ========================================================================================== */

    /* ---------- Config ---------- */
    const API_BASE = "https://toxella-api-yhopcbvaia-uc.a.run.app"; // REQUIRED live base (Cloud Run)
    const FREE_MAX_JOBS = 1;
    const MAX_FILES = 3;
    const MIN_FILES = 1;

    /* ---------- Elements ---------- */
    const $api = document.getElementById('apiBaseLabel');
    const $status = document.getElementById('statusText');
    const $dz = document.getElementById('dropzone');
    const $fileInput = document.getElementById('fileInput');
    const $gallery = document.getElementById('gallery');
    const $context = document.getElementById('context');
    const $generate = document.getElementById('generateBtn');
    const $results = document.getElementById('results');
    const $empty = document.getElementById('empty');
    const $clear = document.getElementById('clearBtn');
    const $limit = document.getElementById('limitNote');
    const $toast = document.getElementById('toast');
    const resultTpl = document.getElementById('resultTpl');

    const $stSelect = document.getElementById('st-select');
    const $stUpload = document.getElementById('st-upload');
    const $stAnalyze = document.getElementById('st-analyze');
    const $stReport = document.getElementById('st-report');

    $api.textContent = API_BASE;

    /* ---------- State ---------- */
    let files = [];        // [{file, id, previewUrl, status}]
    let jobs = [];         // [{id, el}]
    let jobsCount = 0;

    /* ---------- UX helpers ---------- */
    function toast(msg, type='ok', ms=3500){
      const el = document.createElement('div');
      el.className = `t ${type}`;
      el.textContent = msg;
      $toast.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, ms-300);
      setTimeout(()=>{ el.remove(); }, ms);
    }
    function setStatus(s){ $status.textContent = s; }
    function busy(btn, on){
      btn.toggleAttribute('disabled', !!on);
      const label = btn.querySelector('.btn-label');
      if (label) label.textContent = on ? 'Working‚Ä¶' : 'Generate Analysis Report';
    }
    function markSteps(phase){
      [$stSelect,$stUpload,$stAnalyze,$stReport].forEach(el => el.className='step');
      if (phase==='select'){ $stSelect.classList.add('active'); }
      if (phase==='upload'){ $stSelect.classList.add('done'); $stUpload.classList.add('active'); }
      if (phase==='analyze'){ $stSelect.classList.add('done'); $stUpload.classList.add('done'); $stAnalyze.classList.add('active'); }
      if (phase==='report'){ $stSelect.classList.add('done'); $stUpload.classList.add('done'); $stAnalyze.classList.add('done'); $stReport.classList.add('active'); }
    }
    function human(n){ const u=['B','KB','MB','GB']; let i=0,x=n; while(x>=1024&&i<u.length-1){x/=1024;i++;} return `${x.toFixed(x>=10||i===0?0:1)} ${u[i]}`; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]); }
    function toInt(x){ if (typeof x==='number') return Math.round(x<=1?x*100:x); if (typeof x==='string' && /^\d+(\.\d+)?$/.test(x)) return Math.round(parseFloat(x)<=1?parseFloat(x)*100:parseFloat(x)); return 0; }
    function toPct(x){ if (typeof x==='number') return `${Math.round(x<=1?x*100:x)}%`; if (typeof x==='string' && /^\d+%$/.test(x)) return x; if (typeof x==='string' && /^\d+(\.\d+)?$/.test(x)) return `${Math.round(parseFloat(x)<=1?parseFloat(x)*100:parseFloat(x))}%`; return '‚Äî'; }
    function firstNumber(...vals){ for (const v of vals){ if (typeof v==='number' && !isNaN(v)) return v; } return null; }

    /* ---------- File handling ---------- */
    ['dragenter','dragover'].forEach(ev => $dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); $dz.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev => $dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); $dz.classList.remove('drag'); }));
    $dz.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
    $dz.addEventListener('keydown', e => { if (e.key==='Enter' || e.key===' ') $fileInput.click(); });
    $fileInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleFiles(list){
      const arr = Array.from(list || []);
      if (!arr.length) return;
      files = arr.slice(0, MAX_FILES).map((f,i) => ({
        id: `${Date.now()}_${i}`,
        file: f,
        status: 'Selected',
        previewUrl: URL.createObjectURL(f)
      }));
      markSteps('select');
      renderGallery();
      $limit.textContent = jobsCount >= FREE_MAX_JOBS ? 'Free limit reached: clear results to run again.' : '';
      setStatus(`${files.length} file(s) selected`);
      toast(`${files.length} file(s) selected`, 'ok', 2000);
    }

    function renderGallery(){
      $gallery.innerHTML = files.map(item => {
        const {file, status, previewUrl} = item;
        const size = human(file.size);
        const name = escapeHtml(file.name);
        const img = file.type.startsWith('image/') ? `<img src="${previewUrl}" alt="${name} preview">` : 'üìÑ';
        return `
          <div class="file" aria-label="${name}">
            <div class="thumb" aria-hidden="true">${img}</div>
            <div class="meta">
              <div class="name" title="${name}">${name}</div>
              <div class="stat">${size} ‚Ä¢ <span class="st">${status}</span></div>
            </div>
          </div>`;
      }).join('');
    }

    function updateFileStatus(idx, status){
      if (!files[idx]) return;
      files[idx].status = status;
      const card = $gallery.children[idx];
      if (card){
        const st = card.querySelector('.st');
        if (st) st.textContent = status;
      }
    }

    /* ---------- Main flow ---------- */
    $generate.addEventListener('click', startGenerate);
    $clear.addEventListener('click', ()=>{
      $results.innerHTML = '';
      $results.appendChild($empty);
      $empty.style.display='block';
      jobs = []; jobsCount = 0;
      setStatus('Cleared. You can run another report.');
      $limit.textContent = '';
      markSteps('select');
    });

    async function startGenerate(){
      try{
        if (jobsCount >= FREE_MAX_JOBS){
          toast('Free plan limit reached. Clear results to run again.', 'warn');
          setStatus('Free plan limit reached this session.');
          return;
        }
        if (files.length < MIN_FILES) { toast(`Select ${MIN_FILES}‚Äì${MAX_FILES} screenshots first.`, 'warn'); return; }
        if (files.length > MAX_FILES) { toast(`Maximum ${MAX_FILES} files allowed.`, 'warn'); return; }

        busy($generate, true);
        markSteps('upload');
        setStatus('Requesting signed URLs‚Ä¶');

        const signed = await safeJson(fetch(`${API_BASE}/signed-urls`, {
          method:'POST', mode:'cors', credentials:'omit',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ plan:'free', count: files.length })
        }));
        if (!signed.ok) throw new Error(signed.err || 'Failed to get signed URLs');
        const { jobId, urls=[] } = signed.data || {};
        if (!jobId || urls.length < files.length) throw new Error('Server did not provide enough upload slots');

        // Upload files
        for (let i=0;i<files.length;i++){
          updateFileStatus(i, 'Uploading‚Ä¶');
          const f = files[i].file;
          const u = urls[i];
          const ct = u.contentType || f.type || 'application/octet-stream';
          const putRes = await fetch(u.uploadUrl, { method:'PUT', headers:{'Content-Type':ct}, body:f });
          if (!putRes.ok) throw new Error(`Upload failed for ${f.name} (${putRes.status})`);
          updateFileStatus(i, 'Uploaded ‚úì');
        }
        toast('All files uploaded ‚úì', 'ok', 1800);

        // Create job
        markSteps('analyze');
        setStatus('Creating analysis job‚Ä¶');
        const metas = urls.map((u,i)=>({ path:u.path, size: files[i].file.size, mime: files[i].file.type || 'application/octet-stream' }));
        const instructions = ($context.value||'').trim();

        const jobRes = await safeJson(fetch(`${API_BASE}/jobs`, {
          method:'POST', mode:'cors', credentials:'omit',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ jobId, plan:'free', files: metas, ...(instructions?{instructions}:{}) })
        }));
        if (!jobRes.ok) throw new Error(jobRes.err || 'Job creation failed');

        setStatus('Analysis in progress‚Ä¶');
        addResultCard(jobId);
        jobsCount++;
        toast('Job created. Fetching results‚Ä¶', 'ok', 1800);
      }catch(e){
        console.error(e);
        toast(e.message || 'Something went wrong', 'err', 4500);
        setStatus(e.message || 'Something went wrong');
      }finally{
        busy($generate, false);
      }
    }

    async function safeJson(promise){
      try{
        const r = await promise;
        const ct = (r.headers.get('content-type')||'').toLowerCase();
        let data = null;
        if (ct.includes('application/json')) data = await r.json();
        else data = { error: `Unexpected content-type: ${ct||'none'}` };
        return { ok: r.ok, data, err: (!r.ok && (data && (data.error||data.message))) || (!r.ok && `${r.status} ${r.statusText}`) || null };
      }catch(err){ return { ok:false, data:null, err: err.message || 'Network error' }; }
    }

    /* ---------- Results rendering & polling ---------- */
    function addResultCard(jobId){
      if ($empty) $empty.style.display='none';
      const frag = resultTpl.content.cloneNode(true);
      const el = frag.children[0];
      const $statusEl = el.querySelector('.job-status');
      el.querySelector('.job-id').textContent = jobId;

      const tabs = el.querySelectorAll('.tab');
      const $sum = el.querySelector('.sum'), $det = el.querySelector('.det'), $raw = el.querySelector('.raw');
      tabs.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          tabs.forEach(t=>{ t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
          btn.classList.add('active'); btn.setAttribute('aria-selected','true');
          $sum.style.display = btn.classList.contains('tab-sum')?'block':'none';
          $det.style.display = btn.classList.contains('tab-det')?'block':'none';
          $raw.style.display = btn.classList.contains('tab-raw')?'block':'none';
        });
      });

      $results.prepend(el);
      poll();

      async function poll(){
        try{
          const job = await safeJson(fetch(`${API_BASE}/jobs/${encodeURIComponent(jobId)}`, { cache:'no-store', mode:'cors', credentials:'omit' }));
          if (!job.ok) throw new Error(job.err || 'Job status failed');
          const j = job.data || {};
          const st = ((j.status||'').toUpperCase()) || 'PENDING';
          $statusEl.textContent = st;
          $statusEl.className = 'badge ' + (st.includes('COMPLETE') ? 'ok' : st.includes('ERROR') ? 'warn' : 'proc');

          if (j.reportId){
            markSteps('report');
            const repRes = await safeJson(fetch(`${API_BASE}/reports/${encodeURIComponent(j.reportId)}`, { cache:'no-store', mode:'cors', credentials:'omit' }));
            if (!repRes.ok) throw new Error(repRes.err || 'Failed to fetch report');
            const rep = repRes.data;
            renderReportSummary(el, rep, jobId);
            renderReportDetailed(el, rep, jobId);
            renderReportRaw(el, rep);
            setStatus('Analysis complete');
            toast('Report ready ‚úì', 'ok', 2200);
            return;
          }
          if (st.includes('ERROR')){ setStatus('Analysis failed'); toast('Analysis failed', 'err'); return; }
        }catch(e){
          // Soft error: keep polling
          console.warn('Poll error:', e.message);
        }
        setTimeout(poll, 2500);
      }
      jobs.push({id:jobId, el});
    }

    function renderReportRaw(el, rep){
      const $rawJson = el.querySelector('.raw-json');
      if ($rawJson) $rawJson.textContent = JSON.stringify(rep, null, 2);
    }

    function renderReportSummary(el, rep, jobId){
      const $ringWrap = el.querySelector('.ring-wrap');
      const $riskLabel = el.querySelector('.risk-label');
      const $conf = el.querySelector('.conf-val');
      const $cb = el.querySelector('.cb-val');
      const $es = el.querySelector('.es-val');
      const $rc = el.querySelector('.rc-val');
      const $chips = el.querySelector('.tactic-chips');
      const $top3 = el.querySelector('.top3');
      const $receipts = el.querySelector('.receipts-list');

      // <‚Äî FIELD MAPPING
      const score = toInt(rep.risk_score ?? rep.analysis?.risk_score ?? rep.score ?? 0);
      const label = (rep.risk_label || (score<34?'Low':score<=66?'Medium':'High'));
      const conf = rep.confidence ?? rep.analysis?.confidence ?? null;

      const cb = firstNumber(rep.kpis?.communication_balance, rep.analysis?.kpis?.communication_balance, rep.analysis?.communication_balance);
      const es = firstNumber(rep.kpis?.emotional_stability, rep.analysis?.kpis?.emotional_stability, rep.analysis?.emotional_stability);

      const receipts = Array.isArray(rep?.receipts?.highlights) ? rep.receipts.highlights
                      : Array.isArray(rep?.receipts) ? rep.receipts : [];
      const tactics = Array.isArray(rep.tactics) ? rep.tactics : [];

      // Ring + label
      $ringWrap.innerHTML = ring(score);
      $riskLabel.textContent = label;

      // Metrics
      $conf.textContent = toPct(conf);
      $cb.textContent = typeof cb==='number' ? `${Math.round(cb)} / 100` : '‚Äî';
      $es.textContent = typeof es==='number' ? `${Math.round(es)} / 100` : '‚Äî';
      $rc.textContent = `${receipts.length}`;

      // Tactic chips
      $chips.innerHTML = tactics.slice(0,6).map(t=>{
        const name=(t.name||t.id||'').toString();
        const rawScore = (typeof t.score==='number'?t.score:(typeof t.likelihood==='number'?t.likelihood:null));
        const val = rawScore==null ? '' : (rawScore<=1?Math.round(rawScore*100):Math.round(rawScore));
        return `<span class="chip">${escapeHtml(prettyTactic(name))}${val!==''?` ‚Ä¢ ${val}`:''}</span>`;
      }).join('') || `<span class="text-sm">No tactics extracted</span>`;

      // Top 3 (with quotes if present)
      const tScores = tacticScores(tactics);
      const grouped = receiptsByTactic(rep);
      const top = tScores.sort((a,b)=>b.score-a.score).slice(0,3).filter(t=>t.score>0);
      if (!top.length){
        $top3.innerHTML = `<div class="text-sm" style="color:var(--muted)">No strong manipulation indicators detected.</div>`;
      } else {
        $top3.innerHTML = top.map(t=>{
          const id = t.id;
          const quotes = (grouped[id]||[]).slice(0,2).map(q=>`‚Äú${escapeHtml(q)}‚Äù`).join(' ‚Ä¢ ');
          return `<div class="text-sm"><strong>${escapeHtml(TACTIC_NAME[id]||prettyTactic(id))}</strong> ‚Äî <span style="color:var(--muted)">${quotes || 'signals present'}</span></div>`;
        }).join('');
      }

      // Receipts list
      $receipts.innerHTML = receipts.slice(0,12).map(r=>{
        const q = (r.quote || r || '').toString().slice(0,280);
        const cat = r.category || r.tactic || '';
        return `<li>‚Äú${escapeHtml(q)}‚Äù <span class="text-xs" style="margin-left:6px;color:var(--subtle)">${escapeHtml(prettyTactic(cat))}</span></li>`;
      }).join('') || `<li class="text-sm">No quotes extracted</li>`;
    }

    function renderReportDetailed(el, rep, jobId){
      const $narr = el.querySelector('.narrative');
      const $copy = el.querySelector('[data-copy]');
      const $dl = el.querySelector('[data-download]');
      const html = buildPremiumReport(rep);
      $narr.innerHTML = html;
      $copy.onclick = async ()=>{ try{ await navigator.clipboard.writeText($narr.innerText.trim()); toast('Report copied', 'ok'); }catch{} };
      $dl.onclick = ()=>{ const blob = new Blob([$narr.innerText],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`toxella_report_${jobId}.txt`; a.click(); URL.revokeObjectURL(a.href); };
    }

    function ring(score){
      const pct = Math.max(0,Math.min(100,Math.round(score||0)));
      const r=45,c=2*Math.PI*r,d=(pct/100)*c; let col='#16a34a'; if (pct>=67) col='#ef4444'; else if (pct>=34) col='#f59e0b';
      return `<svg class="ring" viewBox="0 0 120 120" role="img" aria-label="Risk ${pct}/100">
        <circle cx="60" cy="60" r="${r}" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--ring').trim()||'#e5e7eb'}" stroke-width="8" fill="none"/>
        <circle cx="60" cy="60" r="${r}" stroke="${col}" stroke-width="8" fill="none" stroke-dasharray="${d} ${c-d}" stroke-linecap="round" transform="rotate(-90 60 60)"/>
        <g class="val"><text x="60" y="63" text-anchor="middle">${pct}</text></g>
      </svg>`;
    }

    /* ---------- Tactics & narrative ---------- */
    const TACTIC_ORDER = ["gaslighting","darvo","blame-shifting","minimization","stonewalling","contempt","guilt-tripping","threats","coercion","triangulation","boundaries","projection"];
    const TACTIC_NAME = {
      "gaslighting":"Gaslighting",
      "darvo":"DARVO (Deny, Attack, Reverse Victim/Offender)",
      "blame-shifting":"Blame-shifting",
      "minimization":"Minimization",
      "stonewalling":"Stonewalling",
      "contempt":"Contempt / Insults",
      "guilt-tripping":"Guilt-tripping",
      "threats":"Threats",
      "coercion":"Coercion / Control",
      "triangulation":"Triangulation",
      "boundaries":"Boundary Misuse",
      "projection":"Projection"
    };
    function prettyTactic(x){
      const id = normId(x);
      return TACTIC_NAME[id] || (String(x||'').charAt(0).toUpperCase()+String(x||'').slice(1));
    }
    function normId(x){
      const s = String(x||'').toLowerCase();
      if (s.includes('boundary')) return 'boundaries';
      if (s.includes('guilt')) return 'guilt-tripping';
      if (s.includes('insult')||s.includes('contempt')) return 'contempt';
      if (s.includes('threat')) return 'threats';
      if (s.includes('coerc')) return 'coercion';
      if (s.includes('minim')) return 'minimization';
      if (s.includes('stone')) return 'stonewalling';
      if (s.includes('triang')) return 'triangulation';
      if (s.includes('shift')) return 'blame-shifting';
      return s;
    }
    function synthScore(t){
      const p = Math.max(0, Math.min(1, t.likelihood ?? 0));
      const s = Math.max(1, Math.min(5, t.severity ?? 3));
      const f = Math.max(0, Math.min(5, t.frequency ?? (t.examples?.length||0)));
      return Math.round(40*p + 35*((s-1)/4) + 25*Math.min(1,f/5));
    }
    function scoreFor(tactics, id){
      const t = (tactics||[]).find(x => normId(x.id||x.name) === id);
      if (!t) return 0;
      if (typeof t.score === 'number') return Math.max(0, Math.min(100, Math.round(t.score<=1?t.score*100:t.score)));
      return synthScore(t);
    }
    function receiptsByTactic(rep){
      const out={};
      const recs = rep?.receipts?.highlights || rep?.receipts || [];
      for (const r of recs){
        const cat = normId(r.category || r.tactic || '');
        const q = (r.quote || r || '').toString().trim();
        if (!q) continue;
        (out[cat] ||= []).push(q.slice(0,280));
      }
      for (const t of (rep.tactics||[])){
        const id = normId(t.id||t.name);
        if (!out[id] && t.examples?.length) out[id] = t.examples.map(x=>String(x).slice(0,280));
      }
      return out;
    }
    function spectrumRow(label, score){
      const pct = Math.max(0,Math.min(100,Math.round(score)));
      return `<div class="srow">
        <div class="lbl">${escapeHtml(label)}</div>
        <div class="meter" role="meter" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${pct}">
          <div class="fill" style="width:${pct}%"></div>
          <div class="caret" style="left:calc(${pct}% - 1px)"></div>
        </div>
      </div>`;
    }
    function tacticScores(tactics){ return TACTIC_ORDER.map(id => ({ id, score: scoreFor(tactics, id) })); }

    function buildPremiumReport(rep){
      // <‚Äî FIELD MAPPING
      const score = toInt(rep.risk_score ?? rep.analysis?.risk_score ?? rep.score ?? 0);
      const label = (rep.risk_label || (score<34?'LOW':score<=66?'MEDIUM':'HIGH'));
      const confPct = toPct(rep.confidence ?? rep.analysis?.confidence ?? 0.85);
      const cb = firstNumber(rep.kpis?.communication_balance, rep.analysis?.kpis?.communication_balance, rep.analysis?.communication_balance);
      const es = firstNumber(rep.kpis?.emotional_stability, rep.analysis?.kpis?.emotional_stability, rep.analysis?.emotional_stability);

      let html = `<div class="text-sm" style="margin-bottom:8px;color:var(--muted)">
        Below is a narrative summary, a 12-tactic spectrum, grouped receipts, and calm response suggestions.</div>`;

      html += `<div><h3 style="margin:6px 0 0">Scores</h3><ul style="margin:6px 0 0 18px">
        <li>Manipulation Risk: <strong>${score} / 100 (${label})</strong></li>
        ${typeof cb==='number'?`<li>Communication Balance: <strong>${Math.round(cb)} / 100</strong></li>`:''}
        ${typeof es==='number'?`<li>Emotional Stability: <strong>${Math.round(es)} / 100</strong></li>`:''}
        <li>Confidence: <strong>${confPct}</strong></li>
      </ul></div>`;

      let spectrum = '';
      const tScores=tacticScores(rep.tactics||[]);
      for (const id of TACTIC_ORDER){ spectrum += spectrumRow(TACTIC_NAME[id], tScores.find(t=>t.id===id)?.score||0); }
      html += `<div style="margin-top:10px"><h3 style="margin:0">Tactic Spectrum</h3>
        <div class="scale"><span>None</span><span>Low</span><span>Medium</span><span>High</span><span>Severe</span></div>
        <div>${spectrum}</div></div>`;

      const top = tScores.slice().sort((a,b)=>b.score-a.score).slice(0,3).filter(t=>t.score>0);
      html += `<div style="margin-top:10px"><h3 style="margin:0">Narrative</h3>
        <p>The conversation presents <strong>${label.toLowerCase()}</strong> manipulation risk overall (score ${score}/100).
        The most salient patterns ${top.length ? 'include ' + top.map(t=>TACTIC_NAME[t.id]).join(', ') : 'are not strongly expressed'}.
        Language shows ${typeof cb==='number'?(cb<40?'dominance/monologue tendencies':'some balance in turn-taking'): 'variable turn-taking'} and ${typeof es==='number'?(es<40?'emotional volatility':'reasonable emotional control'):'mixed emotional tone'}.
        Consider using short, calm prompts that keep focus on one concrete topic at a time.</p></div>`;

      const grouped = receiptsByTactic(rep);
      const any = Object.keys(grouped).some(k => (grouped[k]||[]).length);
      html += `<div style="margin-top:6px"><h3 style="margin:0">Receipts (flagged quotes, grouped)</h3>`;
      if (!any){ html += `<p class="text-sm">No quotable receipts were extracted.</p>`; }
      else {
        for (const id of TACTIC_ORDER){
          const arr = grouped[id]; if (!arr || !arr.length) continue;
          html += `<h4 style="margin:10px 0 6px">${escapeHtml(TACTIC_NAME[id])}</h4>
                   <ul style="margin:0 0 0 18px">${arr.map(q=>`<li>‚Äú${escapeHtml(q)}‚Äù</li>`).join('')}</ul>`;
        }
      }
      html += `</div>`;

      html += `<div style="margin-top:10px"><h3 style="margin:0">Suggested Responses (non-escalating)</h3>
        <ul style="margin:6px 0 0 18px">
          <li>‚ÄúCalling me names doesn‚Äôt address the question. Can you answer directly?‚Äù</li>
          <li>‚ÄúLet‚Äôs stay with this specific event. I‚Äôm asking about that.‚Äù</li>
          <li>‚ÄúIf we can‚Äôt talk respectfully right now, let‚Äôs pause and revisit later.‚Äù</li>
        </ul></div>`;
      return html;
    }
  </script>
</body>
</html>
