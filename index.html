<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Toxella ‚Äî Communication Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Analyze conversation screenshots for manipulation patterns with AI-powered insights." />
  <style>
    /* Modern Design System */
    :root {
      --bg-primary: #fafbfc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f5f7fa;
      --bg-accent: #f0f4ff;

      --text-primary: #1a1d29;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --text-inverse: #ffffff;

      --border-light: #e2e8f0;
      --border-medium: #cbd5e0;
      --border-focus: #4299e1;

      --accent: #4299e1;
      --accent-dark: #2b6cb0;
      --success: #38a169;
      --warning: #ed8936;
      --danger: #e53e3e;

      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;

      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
    }

    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; background: var(--bg-primary); color: var(--text-primary);
      font-family: var(--font-sans); line-height: 1.6;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    /* Layout */
    .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }
    .section { margin: 32px 0; }

    .card {
      background: var(--bg-secondary); border: 1px solid var(--border-light);
      border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); overflow: hidden;
    }
    .card-header { padding: 24px 24px 0; }
    .card-body { padding: 24px; }
    .card-footer {
      padding: 0 24px 24px; border-top: 1px solid var(--border-light); margin-top: 24px; padding-top: 24px;
    }

    /* Typography */
    h1 {
      font-size: 2.5rem; font-weight: 700; letter-spacing: -0.025em; margin: 0;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    h2 { font-size: 1.5rem; font-weight: 600; margin: 0 0 16px 0; color: var(--text-primary); }
    h3 { font-size: 1.25rem; font-weight: 600; margin: 0 0 12px 0; color: var(--text-primary); }
    .text-sm { font-size: 0.875rem; color: var(--text-muted); }
    .text-xs { font-size: 0.75rem; color: var(--text-muted); }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-accent) 100%);
      border-bottom: 1px solid var(--border-light); padding: 32px 0;
    }
    .header-content { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand-icon {
      width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;
    }
    .status-bar { display: flex; align-items: center; gap: 16px; }
    .status-indicator {
      display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-secondary);
      border: 1px solid var(--border-light); border-radius: var(--radius-md); font-size: 0.875rem;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }

    /* Upload Zone */
    .upload-zone {
      border: 2px dashed var(--border-medium); border-radius: var(--radius-lg);
      padding: 48px 24px; text-align: center; background: var(--bg-tertiary);
      transition: all 0.2s ease; cursor: pointer;
    }
    .upload-zone:hover, .upload-zone.drag-over { border-color: var(--accent); background: var(--bg-accent); transform: translateY(-2px); }
    .upload-icon { width: 64px; height: 64px; margin: 0 auto 16px; background: var(--accent); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; }
    .upload-text { font-size: 1.125rem; font-weight: 500; margin-bottom: 8px; color: var(--text-primary); }
    .upload-hint { color: var(--text-muted); margin-bottom: 24px; }

    /* Forms */
    .form-group { margin-bottom: 24px; }
    .form-label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-primary); }
    .form-input, .form-textarea, .form-select {
      width: 100%; padding: 12px 16px; border: 1px solid var(--border-medium); border-radius: var(--radius-md);
      background: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: all 0.2s ease;
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }
    .form-textarea { min-height: 120px; resize: vertical; }
    .form-help { margin-top: 6px; font-size: 0.875rem; color: var(--text-muted); }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; border: 1px solid transparent;
      border-radius: var(--radius-md); font-weight: 500; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; text-decoration: none;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: var(--text-inverse); }
    .btn-primary:hover:not(:disabled) { background: var(--accent-dark); transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-secondary { background: var(--bg-secondary); border-color: var(--border-medium); color: var(--text-primary); }
    .btn-secondary:hover:not(:disabled) { background: var(--bg-tertiary); border-color: var(--border-focus); }
    .btn-danger { background: var(--danger); color: var(--text-inverse); }
    .btn-danger:hover:not(:disabled) { background: #c53030; }
    .btn-lg { padding: 16px 32px; font-size: 1.125rem; }
    .btn-sm { padding: 8px 16px; font-size: 0.875rem; }

    /* Grid */
    .grid { display: grid; gap: 24px; }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
      .header-content { flex-direction: column; text-align: center; }
    }

    /* Progress */
    .progress { margin: 16px 0; padding: 16px; background: var(--bg-accent); border: 1px solid var(--border-light);
      border-radius: var(--radius-md); color: var(--text-secondary); }
    .progress-steps { display: flex; align-items: center; gap: 16px; margin-top: 12px; }
    .progress-step { display: flex; align-items: center; gap: 8px; color: var(--text-muted); }
    .progress-step.active { color: var(--accent); }
    .progress-step.complete { color: var(--success); }

    /* Results */
    .result-card { background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: var(--radius-lg);
      margin-bottom: 24px; overflow: hidden; box-shadow: var(--shadow-sm); }
    .result-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px;
      border-bottom: 1px solid var(--border-light); background: var(--bg-tertiary); }
    .result-meta { display: flex; align-items: center; gap: 12px; }
    .result-status { padding: 4px 12px; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 500;
      text-transform: uppercase; letter-spacing: 0.05em; }
    .status-pending { background: #fef5e7; color: #744210; }
    .status-processing { background: #e6fffa; color: #065f46; }
    .status-complete { background: #d1fae5; color: #065f46; }
    .status-error { background: #fee2e2; color: #991b1b; }

    /* Risk Visualization */
    .risk-display { display: flex; align-items: center; gap: 32px; margin: 24px 0; }
    .risk-circle { position: relative; width: 120px; height: 120px; }
    .risk-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
    .risk-metrics { flex: 1; }
    .metric { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-light); }
    .metric:last-child { border-bottom: none; }
    .metric-label { font-weight: 500; color: var(--text-primary); }
    .metric-value { font-weight: 600; color: var(--accent); }

    /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid var(--border-light); margin-bottom: 24px; }
    .tab{ padding: 12px 24px; border: none; background: none; color: var(--text-muted); font-weight: 500;
      cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s ease; }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab:hover { color: var(--text-primary); }

    /* Hidden */
    .hidden { display: none !important; }

    /* File input */
    .file-input { display: none; }

    /* Utilities */
    .flex{display:flex}.items-center{align-items:center}.justify-between{justify-content:space-between}
    .gap-4{gap:16px}.mt-4{margin-top:16px}.mb-4{margin-bottom:16px}.font-mono{font-family:var(--font-mono)}

    @media (max-width: 768px) {
      .container { padding: 0 16px; }
      .upload-zone { padding: 32px 16px; }
      .risk-display { flex-direction: column; text-align: center; }
      .btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="brand">
          <div class="brand-icon">‚öóÔ∏è</div>
          <div>
            <h1>Toxella</h1>
            <p class="text-sm" style="margin: 0;">Communication Analysis Platform</p>
          </div>
        </div>
        <div class="status-bar">
          <div class="status-indicator">
            <div class="status-dot"></div>
            <span>System Ready</span>
          </div>
          <div class="status-indicator">
            <span class="text-xs font-mono" id="apiBaseLabel"></span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Upload Section -->
    <section class="section">
      <div class="card">
        <div class="card-header">
          <h2>Analyze Conversation Screenshots</h2>
          <p class="text-sm">Upload 2‚Äì3 screenshots of text conversations to identify potential manipulation patterns.</p>
        </div>

        <div class="card-body">
          <div class="upload-zone" id="dropzone" tabindex="0">
            <div class="upload-icon">üì±</div>
            <div class="upload-text">Drop screenshots here or click to browse</div>
            <div class="upload-hint">JPG, PNG ‚Ä¢ Max 3 ‚Ä¢ Images auto-deleted after analysis</div>

            <!-- Hidden file input -->
            <input type="file" class="file-input" id="fileInput" accept="image/*" multiple>
            <!-- Label = native trigger (works even if JS is flaky) -->
            <label class="btn btn-primary" id="chooseBtn" for="fileInput">Choose Files</label>
          </div>

          <div id="progress" class="progress hidden">
            <div><strong>Processing your analysis...</strong></div>
            <div class="progress-steps">
              <div class="progress-step" id="step-upload"><span>üì§</span> Upload</div>
              <div class="progress-step" id="step-analyze"><span>üîç</span> Analyze</div>
              <div class="progress-step" id="step-report"><span>üìä</span> Generate Report</div>
            </div>
            <div class="text-sm mt-4" id="progressText">Initializing‚Ä¶</div>
          </div>

          <div class="grid grid-2 mt-4">
            <div class="form-group">
              <label class="form-label" for="context">Additional Context (Optional)</label>
              <textarea class="form-textarea" id="context" placeholder="Provide brief context that might help (e.g., 'Dad denies last night, flips blame')."></textarea>
              <div class="form-help">This helps the AI sharpen the narrative.</div>
            </div>

            <div class="form-group">
              <label class="form-label" for="method">Upload Method</label>
              <select class="form-select" id="method">
                <option value="signed" selected>Automatic Upload (Recommended)</option>
                <option value="manual">Manual CLI Upload</option>
              </select>
              <div class="form-help">Use manual mode if automatic upload fails.</div>
            </div>
          </div>

          <details id="advanced" class="mt-4">
            <summary class="btn btn-secondary btn-sm">Show Advanced Options</summary>
            <div class="mt-4">
              <div class="text-sm mb-4">If automatic upload fails, use these CLI commands:</div>
              <pre id="cliBlock" class="font-mono text-xs" style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--radius-md); overflow-x: auto;"></pre>
              <div class="flex gap-4 mt-4">
                <button class="btn btn-secondary btn-sm" id="copyCli" type="button">Copy Commands</button>
                <button class="btn btn-primary btn-sm" id="confirmCli" type="button">I Ran Commands ‚Äî Start Polling</button>
              </div>
            </div>
          </details>
        </div>

        <div class="card-footer">
          <div class="flex items-center justify-between">
            <button class="btn btn-primary btn-lg" id="generateBtn" type="button">Generate Analysis Report</button>
            <div class="text-sm">Free plan: 1 report per session</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Results Section -->
    <section class="section">
      <div class="card">
        <div class="card-header">
          <div class="flex items-center justify-between">
            <h2>Analysis Results</h2>
            <button class="btn btn-danger btn-sm" id="deleteAll" type="button">Clear All Results</button>
          </div>
        </div>
        <div class="card-body">
          <div id="results">
            <div class="text-sm" id="resultsPlaceholder" style="text-align:center;padding:48px 0;color:var(--text-muted);">
              No analyses yet. Upload screenshots above to get started.
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Result Template -->
  <template id="resultTpl">
    <div class="result-card">
      <div class="result-header">
        <div class="result-meta">
          <div>
            <div style="font-weight: 600;">Analysis Report</div>
            <div class="text-xs font-mono job-id"></div>
          </div>
          <div class="result-status job-status">pending</div>
        </div>
        <button class="btn btn-secondary btn-sm btn-delete" type="button">Delete</button>
      </div>

      <div class="card-body">
        <div class="tabs">
          <button class="tab tab-sum active" type="button">Summary</button>
          <button class="tab tab-det" type="button">Detailed Report</button>
          <button class="tab tab-raw" type="button">Raw Data</button>
        </div>

        <!-- Summary View -->
        <div class="sum-view">
          <div class="risk-display">
            <div class="ring-wrap"></div>
            <div class="risk-metrics">
              <div class="metric"><span class="metric-label">Analysis Confidence</span><span class="metric-value conf-val">‚Äî</span></div>
              <div class="metric"><span class="metric-label">Communication Balance</span><span class="metric-value cb-val">‚Äî</span></div>
              <div class="metric"><span class="metric-label">Emotional Stability</span><span class="metric-value es-val">‚Äî</span></div>
            </div>
          </div>

          <div class="tactic-chips mt-4"></div>

          <details class="mt-4">
            <summary class="btn btn-secondary btn-sm" type="button">View Evidence Quotes</summary>
            <ul class="receipts-list mt-4"></ul>
          </details>
        </div>

        <!-- Detailed View -->
        <div class="det-view hidden">
          <div class="flex gap-4 mb-4">
            <button class="btn btn-secondary btn-sm btn-copy" type="button">Copy Report</button>
            <button class="btn btn-secondary btn-sm btn-dl" type="button">Download .txt</button>
          </div>
          <div class="narrative"></div>
        </div>

        <!-- Raw Data View -->
        <div class="raw-view hidden">
          <pre class="raw-json font-mono text-xs" style="background:var(--bg-tertiary);padding:16px;border-radius:var(--radius-md);overflow-x:auto;white-space:pre-wrap;"></pre>
        </div>
      </div>
    </div>
  </template>

  <script>
    // --- Config ---
    const DEFAULT_API = "https://toxella-api-yhopcbvaia-uc.a.run.app";
    const API_BASE = new URLSearchParams(location.search).get("api") || DEFAULT_API;
    const BUCKET = "toxella-id-uploads";
    const FREE_MAX_JOBS = 1, MAX_FILES = 3;

    // --- Elements ---
    const $status = document.querySelector('.status-indicator span');
    const $api = document.getElementById('apiBaseLabel');
    const $dz = document.getElementById('dropzone');
    const $fileInput = document.getElementById('fileInput');
    const $method = document.getElementById('method');
    const $context = document.getElementById('context');
    const $advanced = document.getElementById('advanced');
    const $cliBlock = document.getElementById('cliBlock');
    const $copyCli = document.getElementById('copyCli');
    const $confirmCli = document.getElementById('confirmCli');
    const $generate = document.getElementById('generateBtn');
    const $progress = document.getElementById('progress');
    const $progressText = document.getElementById('progressText');
    const $results = document.getElementById('results');
    const $placeholder = document.getElementById('resultsPlaceholder');
    const $deleteAll = document.getElementById('deleteAll');
    const resultTpl = document.getElementById('resultTpl');

    let jobs = [], jobsCount = 0, files = [];

    // --- Init ---
    $api.textContent = API_BASE;

    // Native label handles open. Keep JS fallback for clicking dropzone.
    $dz.addEventListener('click', (e) => {
      const isLabel = e.target && (e.target.tagName === 'LABEL' || e.target.closest('label'));
      if (!isLabel) $fileInput.click();
    });

    // Drag & drop
    ['dragenter','dragover'].forEach(ev =>
      $dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); $dz.classList.add('drag-over'); })
    );
    ['dragleave','drop'].forEach(ev =>
      $dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); $dz.classList.remove('drag-over'); })
    );
    $dz.addEventListener('drop', e => handleFiles(e.dataTransfer.files));

    // File input change
    $fileInput.addEventListener('change', e => handleFiles(e.target.files));

    // --- File handling ---
    function handleFiles(list) {
      files = Array.from(list || []).slice(0, MAX_FILES);
      updateStatus(`${files.length} file(s) selected`);
      if ($advanced.open) renderCLI();
    }
    function updateStatus(message){ $status.textContent = message; }

    function updateProgress(step, message){
      $progressText.textContent = message;
      const steps = ['upload','analyze','report'];
      const currentIndex = steps.indexOf(step);
      steps.forEach((s, i) => {
        const el = document.getElementById(`step-${s}`);
        el.classList.remove('active','complete');
        if (currentIndex === -1) return;
        if (i < currentIndex) el.classList.add('complete');
        else if (i === currentIndex) el.classList.add('active');
      });
    }

    // --- CLI fallback ---
    function renderCLI(){
      if (!files.length){ $cliBlock.textContent = '# Select files first'; return; }
      const D='$';
      const names = files.map(f=>`"${f.name}"`).join(' ');
      const fileJsons = files.map((f,i)=>`{"path":"uploads/${D}JOB_ID/${i}.jpg"}`).join(',');
      $cliBlock.textContent =
`# macOS/Linux
API="${API_BASE}"
BUCKET="${BUCKET}"
JOB_ID="$(uuidgen 2>/dev/null || python3 -c 'import uuid;print(uuid.uuid4())')"
echo "JOB_ID=${D}JOB_ID"

i=0; for f in ${names}; do
  gsutil cp "\${f}" "gs://${D}BUCKET/uploads/${D}JOB_ID/${D}i.jpg"; i=$((i+1));
done

curl -sS -X POST "${D}API/jobs" -H "Content-Type: application/json" -d '{
  "jobId":"'"${D}JOB_ID"'",
  "plan":"free",
  "files":[${fileJsons}],
  "instructions": ${JSON.stringify(JSON.stringify(($context.value||'').trim()))}
}'

watch -n 3 curl -sS "${D}API/jobs/${D}JOB_ID"

# Windows PowerShell
${D}Api="${API_BASE}"
${D}Bucket="${BUCKET}"
${D}JOB_ID=[guid]::NewGuid().Guid
"JOB_ID=${D}JOB_ID"
${files.map((f,i)=>`gsutil cp "${f.name}" "gs://${D}Bucket/uploads/${D}JOB_ID/${i}.jpg"`).join('\n')}
${D}JobJson=@"
{ "jobId":"${D}JOB_ID","plan":"free",
  "files":[${fileJsons}],
  "instructions": ${JSON.stringify(($context.value||'').trim())}
}
"@
Invoke-RestMethod -Method POST -Uri "${D}Api/jobs" -ContentType "application/json" -Body ${D}JobJson
while(${D}true){ curl "${D}Api/jobs/${D}JOB_ID"; Start-Sleep 3 }`;
    }
    $advanced.addEventListener('toggle', ()=>{ if ($advanced.open) renderCLI(); });
    $copyCli.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText($cliBlock.textContent); updateStatus('CLI copied'); }catch{ updateStatus('Copy failed'); } });
    $confirmCli.addEventListener('click', ()=>{ const id = prompt('Paste the JOB_ID printed in your terminal:'); if (id) addResultCard(id); });

    // --- Generate flow ---
    $generate.addEventListener('click', async ()=>{
      try{
        if (jobsCount >= FREE_MAX_JOBS) return updateStatus('Free plan limit reached. Delete results to run again.');
        if (files.length < 2) return updateStatus('Please select at least 2 screenshots.');
        if (files.length > MAX_FILES) return updateStatus(`Maximum ${MAX_FILES} files allowed.`);

        $progress.classList.remove('hidden');
        $generate.disabled = true;

        // Signed URLs
        updateProgress('upload','Requesting upload slots‚Ä¶');
        const req = await fetch(`${API_BASE}/signed-urls`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ plan:'free', count: files.length })
        });
        const up = await req.json();
        if (!req.ok) throw new Error(up.error || 'Upload request failed');
        const { jobId, urls=[] } = up;
        if (!jobId || urls.length < files.length) throw new Error('Server did not provide enough upload slots');

        // Upload
        updateProgress('upload','Uploading screenshots‚Ä¶');
        const metas=[];
        for (let i=0;i<files.length;i++){
          const f = files[i], u = urls[i];
          const ct = u.contentType || f.type || 'application/octet-stream';
          const put = await fetch(u.uploadUrl, { method:'PUT', headers:{'Content-Type':ct}, body:f });
          if (!put.ok) throw new Error(`Upload failed for ${f.name} (${put.status})`);
          metas.push({ path:u.path, size:f.size, mime:f.type || ct });
        }

        // Create job
        updateProgress('analyze','Creating analysis job‚Ä¶');
        const instructions = ($context.value||'').trim();
        const cr = await fetch(`${API_BASE}/jobs`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ jobId, plan:'free', files: metas, ...(instructions?{instructions}:{}) })
        });
        const cj = await cr.json();
        if (!cr.ok) throw new Error(cj.error || 'Job creation failed');

        // Poll
        updateProgress('report','Analysis in progress‚Ä¶');
        addResultCard(jobId);
        jobsCount++;
        updateStatus('Analysis started successfully');
      }catch(err){
        console.error(err);
        updateStatus(err.message || 'Something went wrong');
        $progress.classList.add('hidden');
        $generate.disabled = false;
      }
    });

    // --- Results / polling ---
    function addResultCard(jobId){
      const frag = resultTpl.content.cloneNode(true);
      const el = frag.children[0];
      const $statusEl = el.querySelector('.job-status');
      const $btnDel = el.querySelector('.btn-delete');
      const tabs = el.querySelectorAll('.tab');
      const views = [el.querySelector('.sum-view'), el.querySelector('.det-view'), el.querySelector('.raw-view')];
      const $rawJson = el.querySelector('.raw-json');
      const $ring = el.querySelector('.ring-wrap');

      el.querySelector('.job-id').textContent = jobId;

      // Tabs
      tabs.forEach((tab, idx)=>{
        tab.addEventListener('click', ()=>{
          tabs.forEach(t=>t.classList.remove('active')); views.forEach(v=>v.classList.add('hidden'));
          tab.classList.add('active'); views[idx].classList.remove('hidden');
        });
      });

      // Delete
      $btnDel.addEventListener('click', async ()=>{
        try{ await fetch(`${API_BASE}/jobs/${encodeURIComponent(jobId)}`, { method:'DELETE' }); }catch{}
        el.remove(); jobs = jobs.filter(j=>j.id!==jobId); updateStatus('Job deleted');
      });

      if ($placeholder) $placeholder.style.display = 'none';
      $results.prepend(el);

      // Poll
      async function poll(){
        try{
          const jr = await fetch(`${API_BASE}/jobs/${encodeURIComponent(jobId)}`, { cache:'no-store' });
          const j = await jr.json();
          const st = (j.status||'').toLowerCase();
          $statusEl.textContent = st || 'unknown';
          $statusEl.className = `result-status status-${st.includes('complete')?'complete': st.includes('error')?'error':'processing'}`;

          if (j.reportId){
            const rr = await fetch(`${API_BASE}/reports/${encodeURIComponent(j.reportId)}`, { cache:'no-store' });
            const rep = await rr.json();
            $rawJson.textContent = JSON.stringify(rep, null, 2);

            // Simple summary bits
            const score = Math.round(rep.risk_score ?? rep.analysis?.risk_score ?? 0);
            $ring.innerHTML = riskRingSVG(score);
            const conf = rep.confidence ?? rep.analysis?.confidence ?? null;
            el.querySelector('.conf-val').textContent = (typeof conf === 'number') ? `${Math.round(conf*100)}%` : '‚Äî';

            $progress.classList.add('hidden'); $generate.disabled = false; updateStatus('Analysis complete');
            return;
          }
          if (st.includes('error')) { $progress.classList.add('hidden'); $generate.disabled = false; updateStatus('Analysis failed'); return; }
        }catch(e){ /* ignore transient */ }
        setTimeout(poll, 2500);
      }
      poll();

      jobs.push({ id: jobId, el });
    }

    function riskRingSVG(score){
      const pct = Math.max(0, Math.min(100, Math.round(score||0)));
      const r=45, c=2*Math.PI*r, dash=(pct/100)*c;
      let color='#38a169'; if (pct>=67) color='#e53e3e'; else if (pct>=34) color='#ed8936';
      return `
        <svg class="risk-circle" viewBox="0 0 120 120" role="img" aria-label="Risk ${pct}/100">
          <circle cx="60" cy="60" r="${r}" stroke="#e2e8f0" stroke-width="8" fill="none"/>
          <circle cx="60" cy="60" r="${r}" stroke="${color}" stroke-width="8" fill="none"
                  stroke-dasharray="${dash} ${c-dash}" stroke-linecap="round" transform="rotate(-90 60 60)"/>
          <text x="60" y="60" text-anchor="middle" dominant-baseline="central" class="risk-value">${pct}</text>
        </svg>`;
    }

    // Delete all
    $deleteAll.addEventListener('click', async ()=>{
      for (const job of jobs){ try{ await fetch(`${API_BASE}/jobs/${encodeURIComponent(job.id)}`, { method:'DELETE' }); }catch{} }
      $results.innerHTML = '<div class="text-sm" id="resultsPlaceholder" style="text-align:center;padding:48px 0;color:var(--text-muted);">No analyses yet. Upload screenshots above to get started.</div>';
      jobs=[]; jobsCount=0; updateStatus('All results cleared');
    });
  </script>
</body>
</html>
