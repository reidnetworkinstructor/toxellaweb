<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Toxella — Soft Launch MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Upload 2–3 screenshots, add optional context, and generate a manipulation risk report with summary and a detailed narrative." />
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#ebf0ff; --muted:#a4b1d1; --accent:#8ad1ff; --good:#27c07d; --warn:#ffb020; --bad:#ff5f5f; --border:#233055; --chip:#0e1630; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    a{color:var(--accent);text-decoration:none}
    a:focus,button:focus,input:focus,textarea:focus,select:focus{outline:2px dashed var(--accent);outline-offset:2px}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin:16px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    @media (max-width:760px){.grid.cols-2{grid-template-columns:1fr}}
    .pill{font-size:.9rem;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0e1630}
    .small{font-size:.92rem;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .divider{height:1px;background:var(--border);margin:14px 0}
    label{font-weight:600}
    input[type="file"],textarea,select{border:1px solid var(--border);background:#0f172a;color:var(--text);padding:10px;border-radius:10px}
    textarea{width:100%;min-height:110px;resize:vertical}
    button{background:#1b2948;border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    button.primary{background:#22406a}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .right{margin-left:auto}
    /* Dropzone */
    .dz{border:2px dashed var(--border);border-radius:12px;padding:18px;text-align:center;background:#0c1428}
    .dz.drag{border-color:var(--accent);background:#0d1832}
    .dz .hint{color:var(--muted);font-size:.95rem}
    /* Tabs */
    .tabs{display:flex;gap:8px;margin:8px 0}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0e1630;cursor:pointer}
    .tab.active{background:#203860}
    .hidden{display:none}
    /* Chips */
    .chip{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;margin:2px 6px 2px 0}
    .bar{display:inline-block;height:6px;width:70px;background:#0a1226;border-radius:4px;overflow:hidden}
    .bar > i{display:block;height:100%;background:#7fb3ff}
    /* Risk ring */
    .ring{width:110px;height:110px}
    .ring .num{font-weight:700;font-size:1.2rem;fill:#eaf0ff}
    /* Code block */
    code.block{display:block;background:#0a1226;border:1px solid var(--border);padding:12px;border-radius:10px;overflow:auto}

    /* === Tactic spectrum === */
    .spectrum { margin-top:8px; }
    .srow { display:flex; align-items:center; gap:10px; margin:8px 0; }
    .srow .lbl { width:160px; min-width:140px; font-weight:600; }
    @media (max-width:760px){ .srow .lbl{ width:120px; } }
    .meter { position:relative; flex:1; height:12px; background:#0a1226; border:1px solid var(--border); border-radius:999px; overflow:hidden; }
    .meter .fill { position:absolute; left:0; top:0; bottom:0; background:#7fb3ff; }
    .meter .caret { position:absolute; top:-4px; width:2px; height:20px; background:#eaf0ff; box-shadow:0 0 0 2px rgba(234,240,255,.15); }
    .scale { display:flex; justify-content:space-between; font-size:.75rem; color:var(--muted); margin-top:4px; }
    .block { margin:12px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card" role="banner">
      <div class="row">
        <h1 style="margin:0;">🧪 Toxella</h1>
        <span class="pill">Free: 1 report • up to 3 images</span>
        <span class="right small">API: <span id="apiBaseLabel" class="mono"></span></span>
      </div>
      <p id="status" class="small" aria-live="polite">Ready.</p>
    </header>

    <!-- 1) Upload & Context -->
    <section class="card" aria-label="Upload and context">
      <h2 style="margin:0 0 8px">Diagnose screenshots</h2>
      <div id="dropzone" class="dz" tabindex="0" aria-label="Screenshot dropzone">
        <div><strong>Drop 2–3 screenshots</strong> (JPG/PNG) or</div>
        <div style="margin-top:8px">
          <input id="fileInput" type="file" accept="image/*" multiple style="display:none" />
          <button id="chooseBtn" class="primary">Choose files</button>
        </div>
        <div class="hint" style="margin-top:8px">We auto-delete images after analysis. Only the JSON report is stored.</div>
      </div>

      <div class="grid cols-2" style="margin-top:8px">
        <div>
          <label for="context">Extra context (optional)</label>
          <textarea id="context" placeholder="Who’s speaking to you? What are you worried about? e.g., “Dad keeps denying something and flipping blame.”"></textarea>
          <div class="small">We’ll pass this to analysis to sharpen the narrative. Keep it brief.</div>
        </div>
        <div>
          <label for="method">Upload method</label>
          <select id="method">
            <option value="signed" selected>Signed URLs (automatic)</option>
            <option value="manual">Manual (CLI fallback)</option>
          </select>
          <details id="advanced" style="margin-top:10px">
            <summary><strong>Advanced</strong> — CLI fallback & settings</summary>
            <div class="small" style="margin:10px 0">If browser uploads fail or CORS blocks you, use these commands.</div>
            <code id="cliBlock" class="block mono" aria-label="CLI commands"></code>
            <div class="row" style="margin-top:8px">
              <button id="copyCli">Copy commands</button>
              <button id="confirmCli" class="primary">I ran these — Start polling</button>
            </div>
          </details>
        </div>
      </div>

      <div class="divider"></div>

      <!-- 2) Generate -->
      <div class="row">
        <button id="generateBtn" class="primary">Generate report</button>
        <span id="progress" class="small" aria-live="polite"></span>
      </div>
    </section>

    <!-- 3) Results -->
    <section class="card" aria-label="Results">
      <div class="row">
        <h2 style="margin:0">Results</h2>
        <button id="deleteAll" class="right" title="Delete all results from this page (best-effort)">Delete all</button>
      </div>
      <div id="results"></div>
    </section>

    <footer class="card small" aria-label="Footer">
      <div>Privacy: Images auto-delete (bucket lifecycle). Only structured JSON is stored. You can request deletion anytime.</div>
      <div style="margin-top:6px">
        <a href="#" aria-label="Terms link">Terms</a> ·
        <a href="#" aria-label="Privacy link">Privacy</a>
      </div>
    </footer>
  </div>

  <template id="resultTpl">
    <div class="card">
      <div class="row">
        <div><strong>Job</strong> <span class="mono job-id"></span></div>
        <span class="pill job-status">pending</span>
        <button class="right btn-delete" title="Delete this job (best-effort)">Delete</button>
      </div>
      <div class="small">Created: <span class="job-created"></span></div>

      <div class="divider"></div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab tab-sum active" type="button">Summary</button>
        <button class="tab tab-det" type="button">Detailed report</button>
      </div>

      <!-- Summary tab -->
      <div class="sum-view">
        <div class="row" style="align-items:flex-start">
          <div class="ring-wrap"></div>
          <div style="flex:1;min-width:240px">
            <div class="row">
              <span class="chip"><strong>Confidence</strong> <span class="small conf-val"></span></span>
              <span class="chip"><strong>Comm. balance</strong> <span class="small cb-val"></span></span>
              <span class="chip"><strong>Emotional stability</strong> <span class="small es-val"></span></span>
            </div>
            <div style="margin-top:10px" class="tactic-chips"></div>
            <details style="margin-top:10px">
              <summary>View receipts (quotes)</summary>
              <ul class="receipts-list"></ul>
            </details>
          </div>
        </div>
      </div>

      <!-- Detailed tab -->
      <div class="det-view hidden">
        <div class="row" style="gap:8px;margin-bottom:8px">
          <button class="btn-copy">Copy report</button>
          <button class="btn-dl">Download .txt</button>
        </div>
        <div class="narrative"></div>
      </div>

      <details style="margin-top:10px">
        <summary>Raw JSON</summary>
        <pre class="mono raw-json" style="white-space:pre-wrap"></pre>
      </details>
    </div>
  </template>

  <script>
    // ===== Config =====
    const DEFAULT_API = "https://toxella-api-yhopcbvaia-uc.a.run.app";
    const API_BASE = new URLSearchParams(location.search).get("api") || DEFAULT_API;
    const BUCKET = "toxella-id-uploads";
    const FREE_MAX_JOBS = 1, MAX_FILES = 3;

    // ===== Elements =====
    const $status = document.getElementById('status');
    const $progress = document.getElementById('progress');
    const $api = document.getElementById('apiBaseLabel');
    const $dz = document.getElementById('dropzone');
    const $fileInput = document.getElementById('fileInput');
    const $chooseBtn = document.getElementById('chooseBtn');
    const $method = document.getElementById('method');
    const $context = document.getElementById('context');
    const $advanced = document.getElementById('advanced');
    const $cliBlock = document.getElementById('cliBlock');
    const $copyCli = document.getElementById('copyCli');
    const $confirmCli = document.getElementById('confirmCli');
    const $generate = document.getElementById('generateBtn');
    const $results = document.getElementById('results');
    const $deleteAll = document.getElementById('deleteAll');
    const resultTpl = document.getElementById('resultTpl');

    let jobs = [], jobsCount = 0, files = [];

    // ===== Helpers =====
    const setStatus = (t)=> $status.textContent = t;
    const setProg = (t)=> $progress.textContent = t;
    function ensureFiles(){
      if (files.length < 2) throw new Error("Please add at least 2 screenshots.");
      if (files.length > MAX_FILES) throw new Error(`Up to ${MAX_FILES} images on the free plan.`);
    }
    function riskRingSVG(score){
      const pct = Math.max(0, Math.min(100, Math.round(score||0)));
      const r=45, c=2*Math.PI*r, dash = (pct/100)*c;
      let color = '#27c07d'; if (pct>=67) color='#ff5f5f'; else if (pct>=34) color='#ffb020';
      return `
        <svg class="ring" viewBox="0 0 110 110" role="img" aria-label="Risk ${pct}/100">
          <circle cx="55" cy="55" r="${r}" stroke="#1a2746" stroke-width="12" fill="none"/>
          <circle cx="55" cy="55" r="${r}" stroke="${color}" stroke-width="12" fill="none"
                  stroke-dasharray="${dash} ${c-dash}" stroke-linecap="round" transform="rotate(-90 55 55)"/>
          <text x="55" y="55" text-anchor="middle" dominant-baseline="central" class="num">${pct}</text>
        </svg>`;
    }
    function mdLite(md){
      if (!md) return "";
      const esc = s => s.replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
      md = md.replace(/\r\n/g,'\n').trim();
      md = md.replace(/^#{1,6}\s*(.+)$/gm, (_,t)=>`<h3>${esc(t)}</h3>`);
      md = md.replace(/\*\*(.+?)\*\*/g,(_,t)=>`<strong>${esc(t)}</strong>`);
      md = md.replace(/^\s*[-•]\s+(.+)$/gm,(_,t)=>`<li>${esc(t)}</li>`);
      md = md.replace(/(\n{2,})/g,'</p><p>');
      md = `<p>${md}</p>`.replace(/(<p>\s*)<li>/g,'<ul><li>').replace(/<\/li>\s*<\/p>/g,'</li></ul>');
      return md;
    }

    // ===== Premium narrative helpers =====
    const TACTIC_ORDER = [
      "gaslighting","darvo","blame-shifting","minimization","stonewalling","contempt",
      "guilt-tripping","threats","coercion","triangulation","boundaries","projection"
    ];
    const TACTIC_NAME = {
      "gaslighting":"Gaslighting",
      "darvo":"DARVO (Deny, Attack, Reverse Victim/Offender)",
      "blame-shifting":"Blame-shifting",
      "minimization":"Minimization",
      "stonewalling":"Stonewalling",
      "contempt":"Contempt / Insults",
      "guilt-tripping":"Guilt-tripping",
      "threats":"Threats",
      "coercion":"Coercion / Control",
      "triangulation":"Triangulation",
      "boundaries":"Boundary Misuse",
      "projection":"Projection"
    };
    const TACTIC_DESC = {
      "gaslighting":"Denies or distorts reality to make you doubt your memory, perception, or sanity.",
      "darvo":"Flips roles: denies harm, attacks the accuser, and claims to be the real victim.",
      "blame-shifting":"Redirects responsibility for their behavior back onto you or others.",
      "minimization":"Downplays the seriousness of events or your feelings to avoid accountability.",
      "stonewalling":"Refuses to engage, delays, or shuts down discussion to block resolution.",
      "contempt":"Mocks, belittles, or insults you; communicates superiority or disgust.",
      "guilt-tripping":"Leverages guilt to coerce compliance or apology when you did not do wrong.",
      "threats":"Explicit or implied threats to punish, harm, or abandon if you don’t comply.",
      "coercion":"Controls choices through pressure, ultimatums, or consequences.",
      "triangulation":"Pulls in third parties to intimidate, discredit, or create alliances.",
      "boundaries":"Invokes ‘boundaries’ selectively to dodge accountability or control access.",
      "projection":"Accuses you of the very behavior they are doing to avoid owning it."
    };
    function scoreSynthesize(t){
      const p = Math.max(0, Math.min(1, t.likelihood ?? 0));
      const s = Math.max(1, Math.min(5, t.severity ?? 3));
      const f = Math.max(0, Math.min(5, t.frequency ?? (t.examples?.length||0)));
      return Math.round(40*p + 35*((s-1)/4) + 25*Math.min(1,f/5));
    }
    function scoreFor(tactics, id){
      const t = (tactics||[]).find(x => (String(x.id||x.name||'').toLowerCase()) === id);
      if (!t) return 0;
      if (typeof t.score === 'number') return Math.max(0, Math.min(100, Math.round(t.score)));
      return scoreSynthesize(t);
    }
    function examplesFor(rep, id, limit=6){
      const receipts = (rep.receipts || rep.receipts?.highlights || []);
      const grouped = {};
      for (const r of receipts){
        const cat = String(r.category || r.tactic || '').toLowerCase();
        const q = (r.quote || r || '').toString().trim();
        if (!q) continue;
        (grouped[cat] ||= []).push(q);
      }
      let arr = grouped[id] || [];
      if (!arr.length){
        const t = (rep.tactics||[]).find(x => (String(x.id||x.name||'').toLowerCase()) === id);
        arr = (t && t.examples) ? t.examples : [];
      }
      const seen = new Set(), out=[];
      for (const q of arr){
        const qq = q.slice(0,280);
        if (!seen.has(qq)){ out.push(qq); seen.add(qq); }
        if (out.length >= limit) break;
      }
      return out;
    }
    function spectrumRowHTML(label, score){
      const pct = Math.max(0, Math.min(100, Math.round(score)));
      return `
        <div class="srow">
          <div class="lbl">${label}</div>
          <div class="meter" role="meter" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${pct}">
            <div class="fill" style="width:${pct}%"></div>
            <div class="caret" style="left: calc(${pct}% - 1px)"></div>
          </div>
        </div>`;
    }
    function buildPremiumReport(rep){
      const score = Math.round(rep.risk_score ?? 0);
      const label = (rep.risk_label || (score<34?'low':score<=66?'medium':'high')).toUpperCase();
      const confPct = Math.round((rep.confidence ?? 0.85) * 100);
      const cb = typeof rep.kpis?.communication_balance === 'number' ? Math.round(rep.kpis.communication_balance) : null;
      const es = typeof rep.kpis?.emotional_stability   === 'number' ? Math.round(rep.kpis.emotional_stability)   : null;

      // Scores header
      let scoresHTML = `<div class="block"><h3 style="margin:6px 0">Scores</h3>
        <ul>
          <li>Manipulation Risk: <strong>${score} / 100 (${label})</strong></li>
          ${cb !== null ? `<li>Communication Balance: <strong>${cb} / 100</strong></li>` : ''}
          ${es !== null ? `<li>Emotional Stability: <strong>${es} / 100</strong></li>` : ''}
          <li>Confidence: <strong>${confPct}%</strong></li>
        </ul></div>`;

      // Spectrum (all 12)
      let spectrumHTML = '<div class="block"><h3 style="margin:6px 0">Tactic spectrum</h3><div class="spectrum">';
      const tacticScores = [];
      for (const id of TACTIC_ORDER){
        const s = scoreFor(rep.tactics, id);
        tacticScores.push({ id, score: s });
        spectrumHTML += spectrumRowHTML(TACTIC_NAME[id], s);
      }
      spectrumHTML += `</div><div class="scale"><span>None</span><span>Low</span><span>Medium</span><span>High</span><span>Severe</span></div></div>`;

      // Top tactics
      const top = tacticScores.slice().sort((a,b)=>b.score-a.score).slice(0,3).filter(t=>t.score>0);
      let topHTML = '<div class="block"><h3 style="margin:6px 0">Top tactics (what it looks like)</h3>';
      if (top.length === 0){
        topHTML += '<p class="small">No strong manipulation indicators were detected. Some language may still be unhelpful or tense.</p>';
      } else {
        for (const t of top){
          const id = t.id, name = TACTIC_NAME[id];
          const ex = examplesFor(rep, id, 3);
          topHTML += `<div class="block">
            <div class="row" style="align-items:center">
              <strong>${name}</strong>
              <span class="pill">${t.score}/100</span>
            </div>
            <div class="small" style="margin:6px 0">${TACTIC_DESC[id]}</div>
            ${ex.length ? `<ul>${ex.map(q=>`<li>“${q}”</li>`).join('')}</ul>` : '<div class="small">Signals present, no quotable snippets extracted.</div>'}
          </div>`;
        }
      }
      topHTML += '</div>';

      // Executive summary
      const execHTML = `<div class="block">
        <h3 style="margin:6px 0">Summary</h3>
        <p>This conversation shows ${label==='HIGH'?'severe':label==='MEDIUM'?'elevated':'low'} manipulation risk. The most salient patterns are
          ${top.length ? top.map(t=>TACTIC_NAME[t.id]).join(', ') : 'no strong tactics'}.
          Use the receipts below as evidence and consider calm boundary-setting responses.</p>
      </div>`;

      // Receipts grouped
      let receiptsHTML = '<div class="block"><h3 style="margin:6px 0">Receipts (flagged quotes, grouped)</h3>';
      const byTactic = {};
      for (const id of TACTIC_ORDER){
        const ex = examplesFor(rep, id, 20);
        if (ex.length){ byTactic[id] = ex; }
      }
      if (Object.keys(byTactic).length === 0){
        receiptsHTML += '<p class="small">No quotable receipts were extracted from the screenshots.</p>';
      } else {
        for (const id of TACTIC_ORDER){
          const arr = byTactic[id]; if (!arr) continue;
          receiptsHTML += `<h4 style="margin:10px 0 4px">${TACTIC_NAME[id]}</h4><ul>${arr.map(q=>`<li>“${q}”</li>`).join('')}</ul>`;
        }
      }
      receiptsHTML += '</div>';

      // Tips
      const tipsHTML = `<div class="block">
        <h3 style="margin:6px 0">Suggested responses (non-escalating)</h3>
        <ul>
          <li>“Calling me names doesn’t address the question. Can you answer directly?”</li>
          <li>“I’m asking about <em>this specific event</em>. Let’s stay with that.”</li>
          <li>“If we can’t talk respectfully right now, let’s pause and revisit later.”</li>
        </ul>
      </div>`;

      return scoresHTML + spectrumHTML + topHTML + execHTML + receiptsHTML + tipsHTML;
    }

    // ===== Dropzone =====
    document.getElementById('apiBaseLabel').textContent = API_BASE;
    const handleFiles = (list)=>{
      files = Array.from(list||[]).slice(0, MAX_FILES);
      setStatus(`${files.length} file(s) selected.`);
      if ($advanced.open) renderCLI();
    };
    document.getElementById('chooseBtn').onclick = ()=> $fileInput.click();
    $fileInput.onchange = (e)=> handleFiles(e.target.files);
    ['dragenter','dragover'].forEach(ev => $dz.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); $dz.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(ev => $dz.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); $dz.classList.remove('drag'); }));
    $dz.addEventListener('drop', (e)=> handleFiles(e.dataTransfer.files));

    // ===== CLI fallback generator =====
    function renderCLI(){
      if (!files.length){ $cliBlock.textContent = '# Select files first'; return; }
      const D='$';
      const names = files.map(f=>`"${f.name}"`).join(' ');
      const fileJsons = files.map((f,i)=>`{"path":"uploads/${D}JOB_ID/${i}.jpg"}`).join(',');
      $cliBlock.textContent =
`# macOS/Linux
API="${API_BASE}"
BUCKET="${BUCKET}"
JOB_ID="$(uuidgen 2>/dev/null || python3 -c 'import uuid;print(uuid.uuid4())')"
echo "JOB_ID=${D}JOB_ID"

i=0; for f in ${names}; do
  gsutil cp "\${f}" "gs://${D}BUCKET/uploads/${D}JOB_ID/${D}i.jpg"; i=$((i+1));
done

curl -sS -X POST "${D}API/jobs" -H "Content-Type: application/json" -d '{
  "jobId":"'"${D}JOB_ID"'",
  "plan":"free",
  "files":[${fileJsons}],
  "instructions": ${JSON.stringify(JSON.stringify(($context.value||'').trim()))}
}'

watch -n 3 curl -sS "${D}API/jobs/${D}JOB_ID"

# Windows PowerShell
${D}Api="${API_BASE}"
${D}Bucket="${BUCKET}"
${D}JOB_ID=[guid]::NewGuid().Guid
"JOB_ID=${D}JOB_ID"
${files.map((f,i)=>`gsutil cp "${f.name}" "gs://${D}Bucket/uploads/${D}JOB_ID/${i}.jpg"`).join('\n')}
${D}JobJson=@"
{ "jobId":"${D}JOB_ID","plan":"free",
  "files":[${fileJsons}],
  "instructions": ${JSON.stringify(($context.value||'').trim())}
}
"@
Invoke-RestMethod -Method POST -Uri "${D}Api/jobs" -ContentType "application/json" -Body ${D}JobJson
while(${D}true){ curl "${D}Api/jobs/${D}JOB_ID"; Start-Sleep 3 }`;
    }
    $advanced.addEventListener('toggle', ()=>{ if ($advanced.open) renderCLI(); });
    $copyCli.onclick = async ()=> { try{ await navigator.clipboard.writeText($cliBlock.textContent); setStatus('CLI copied'); }catch{ setStatus('Copy failed'); } };
    $confirmCli.onclick = ()=> {
      const id = prompt('Paste the JOB_ID printed in your terminal:');
      if (id) addResultCard(id);
    };

    // ===== Primary action =====
    $generate.onclick = async ()=>{
      try{
        if (jobsCount >= FREE_MAX_JOBS) return setStatus('Free plan limit: 1 report. Delete results to run again.');
        ensureFiles();

        if ($method.value === 'manual'){
          $advanced.open = true; renderCLI();
          setStatus('Manual mode: run the CLI commands shown, then click “Start polling”.');
          return;
        }

        // Signed URL flow
        setProg('Requesting upload slots…');
        const r = await fetch(`${API_BASE}/signed-urls`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ plan:'free', count: files.length }) });
        const j = await r.json(); if (!r.ok) throw new Error(j.error||'signed-urls failed');
        const { jobId, urls=[] } = j; if (!jobId || urls.length < files.length) throw new Error('Not enough upload slots');

        setProg('Uploading images…');
        const metas=[];
        for (let i=0;i<files.length;i++){
          const f=files[i], u=urls[i], ct=u.contentType||f.type||'application/octet-stream';
          const pr = await fetch(u.uploadUrl, { method:'PUT', headers:{'Content-Type':ct}, body:f });
          if (!pr.ok) throw new Error(`PUT failed for ${f.name} (${pr.status})`);
          metas.push({ path: u.path, size: f.size, mime: f.type || ct });
        }

        setProg('Queuing analysis…');
        const instructions = ($context.value||'').trim();
        const cr = await fetch(`${API_BASE}/jobs`, { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ jobId, plan:'free', files: metas, ...(instructions?{instructions}:{} ) })
        });
        const cj = await cr.json(); if (!cr.ok) throw new Error(cj.error||'create job failed');

        setProg('Queued. Polling…');
        addResultCard(jobId);
        jobsCount++; setStatus('Job created.');
      }catch(e){
        console.error(e);
        setProg('');
        setStatus((e && e.message) ? e.message : 'Something went wrong.');
        if ($method.value==='signed') { $advanced.open = true; renderCLI(); }
      }
    };

    // ===== Results & polling =====
    function addResultCard(id){
      const frag = resultTpl.content.cloneNode(true);
      const el = frag.children[0];
      const $statusEl = el.querySelector('.job-status');
      const $ring = el.querySelector('.ring-wrap');
      const $chips = el.querySelector('.tactic-chips');
      const $rec = el.querySelector('.receipts-list');
      const $raw = el.querySelector('.raw-json');
      const $conf = el.querySelector('.conf-val');
      const $cb = el.querySelector('.cb-val');
      const $es = el.querySelector('.es-val');
      const $btnDel = el.querySelector('.btn-delete');
      const $tabSum = el.querySelector('.tab-sum');
      const $tabDet = el.querySelector('.tab-det');
      const $sum = el.querySelector('.sum-view');
      const $det = el.querySelector('.det-view');
      const $narr = el.querySelector('.narrative');
      const $copy = el.querySelector('.btn-copy');
      const $dl = el.querySelector('.btn-dl');

      el.querySelector('.job-id').textContent = id;
      el.querySelector('.job-created').textContent = new Date().toLocaleString();

      $btnDel.onclick = async ()=>{ try{ await fetch(`${API_BASE}/jobs/${encodeURIComponent(id)}`,{method:'DELETE'});}catch{} el.remove(); jobs = jobs.filter(x=>x.id!==id); };

      $tabSum.onclick = ()=>{ $tabSum.classList.add('active'); $tabDet.classList.remove('active'); $sum.classList.remove('hidden'); $det.classList.add('hidden'); };
      $tabDet.onclick = ()=>{ $tabDet.classList.add('active'); $tabSum.classList.remove('active'); $det.classList.remove('hidden'); $sum.classList.add('hidden'); };

      $results.prepend(el);

      async function poll(){
        try{
          const jr = await fetch(`${API_BASE}/jobs/${encodeURIComponent(id)}`, { cache:'no-store' });
          const j = await jr.json();
          const st = (j.status||'').toLowerCase();
          $statusEl.textContent = st || 'unknown';
          $statusEl.className = 'pill job-status ' + (st.includes('complete')?'': st.includes('error')?'bad':'warn');
          if (j.reportId){
            const rr = await fetch(`${API_BASE}/reports/${encodeURIComponent(j.reportId)}`, { cache:'no-store' });
            const rep = await rr.json();
            $raw.textContent = JSON.stringify(rep, null, 2);

            // Summary
            const score = Math.round(rep.risk_score ?? rep.analysis?.risk_score ?? 0);
            $ring.innerHTML = riskRingSVG(score);
            const conf = rep.confidence ?? rep.analysis?.confidence ?? null;
            $conf.textContent = (typeof conf === 'number') ? `${Math.round(conf*100)}%` : '—';
            const cb = rep.kpis?.communication_balance; $cb.textContent = (typeof cb==='number') ? `${Math.round(cb)}` : '—';
            const es = rep.kpis?.emotional_stability;   $es.textContent = (typeof es==='number') ? `${Math.round(es)}` : '—';

            // Tactic chips
            const tacts = (rep.tactics||[]).slice(0,6);
            $chips.innerHTML = '';
            for (const t of tacts){
              const like = Math.round((t.likelihood||0)*100);
              const elc = document.createElement('span');
              elc.className = 'chip';
              elc.innerHTML = `<strong>${t.name || t.id}</strong>
                <span class="bar" title="likelihood ${like}%"><i style="width:${like}%"></i></span>`;
              $chips.appendChild(elc);
            }

            // Receipts preview
            const recs = rep.receipts || rep.receipts?.highlights || [];
            $rec.innerHTML = recs.slice(0,10).map(r=>`<li>“${(r.quote || r).toString()}” <span class="small mono">· ${r.category||'evidence'}</span></li>`).join('');

            // Detailed: premium report (uses receipts + tactics to build grouped narrative)
            $narr.innerHTML = buildPremiumReport(rep);

            // Copy/Download
            $copy.onclick = async ()=>{ try{ await navigator.clipboard.writeText($narr.innerText.replace(/\n{3,}/g,'\n\n').trim()); setStatus('Report copied'); }catch{ setStatus('Copy failed'); } };
            $dl.onclick = ()=>{ const blob = new Blob([$narr.innerText], {type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`toxella_report_${id}.txt`; a.click(); URL.revokeObjectURL(a.href); };

            setProg(''); setStatus('Analysis complete.');
            return;
          }
          if (st.includes('error')) { setProg(''); return; }
        }catch{}
        setTimeout(poll, 2500);
      }
      poll();

      jobs.push({ id, el });
    }

    // Delete all on page (best-effort)
    $deleteAll.onclick = async ()=>{
      for (const j of jobs){ try{ await fetch(`${API_BASE}/jobs/${encodeURIComponent(j.id)}`, { method:'DELETE' }); }catch{} }
      $results.innerHTML=''; jobs=[]; jobsCount=0; setStatus('Requested deletion for all jobs (best-effort).');
    };

    // Init
    setStatus('Ready. Add 2–3 screenshots and click Generate.');
  </script>
</body>
</html>
